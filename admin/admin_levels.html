<!DOCTYPE html>
<html lang="th">
<head>
    <script>
    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Security Check) ---
    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤ 'admin_logged_in' ‡πÄ‡∏õ‡πá‡∏ô 'true'
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        // ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡∏≠‡∏¢‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ 1 ‡∏Ç‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ admin_login)
        window.location.href = '../admin_login/index.html';
    }
</script>
    <meta charset="UTF-8">
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="js/admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .table-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; } 
        th, td { padding: 12px 10px; font-size: 11px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; text-align: center; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        tr:hover { background-color: #f8fafc; transition: 0.2s; }
        input { transition: 0.2s; }
        .modal-scale-in { animation: scaleIn 0.2s ease-out forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <script src="js/admin_ui.js"></script>
    <script src="js/firebase_setup.js"></script> 

    <script>
        renderAdminUI('members', 'levels'); 

        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-5 shadow-sm border-b flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">üëë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Member Levels)</h2>
                    <p class="text-xs text-gray-500 mt-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡∏∞‡∏î‡∏±‡∏ö</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mx-4 overflow-hidden">
                <div class="table-wrapper custom-scroll">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</th>
                                <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                                <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø</th>
                                <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏ñ‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô</th>
                                <th>‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                                <th>‡∏ñ‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                                <th>‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏ç</th>
                                <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="levels-body">
                            <tr><td colspan="13" class="text-center p-12 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // --- Create Edit Modal ---
        const modalHtml = `
        <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 modal-scale-in relative max-h-[90vh] overflow-y-auto">
                <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                
                <input type="hidden" id="edit-doc-id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <input type="text" id="edit-name" class="w-full border rounded p-2 text-sm bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="edit-price" class="w-full border rounded p-2 text-sm bg-blue-50 text-blue-700 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø (‡πÄ‡∏ä‡πà‡∏ô 0.0050)</label>
                        <input type="number" step="0.0001" id="edit-rate" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (L1/L2/L3)</label>
                        <input type="text" id="edit-ref-rate" class="w-full border rounded p-2 text-sm" placeholder="0/0/0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (min_bal)</label>
                        <input type="number" id="edit-min-bal" class="w-full border rounded p-2 text-sm text-red-600 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</label>
                        <input type="number" id="edit-orders" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</label>
                        <input type="number" id="edit-withdraw-count" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="edit-min-withdraw" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">‡∏ñ‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="edit-max-withdraw" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">
                            <i class="fa-regular fa-image"></i> ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (URL) ‡∏´‡∏£‡∏∑‡∏≠ Class
                        </label>
                        <input type="text" id="edit-icon" class="w-full border-2 border-indigo-100 rounded p-2 text-sm focus:border-indigo-500 focus:outline-none placeholder-gray-300">
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-2">
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveLevelChanges()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);


        // --- LOGIC ---
        let allLevels = [];

        function fetchLevels() {
            if (!window.db) return setTimeout(fetchLevels, 1000);

            // ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ Collection ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB ‡∏à‡∏£‡∏¥‡∏á: "levels"
            db.collection("levels").orderBy("price", "asc").onSnapshot((snapshot) => {
                const tbody = document.getElementById('levels-body');
                allLevels = [];
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="13" class="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                let index = 1;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const docId = doc.id;
                    allLevels.push({ docId, ...d });

                    // Map ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB
                    const minBal = d.min_bal || 0;
                    const orderCount = d.orders || 0;
                    const withdrawLimit = d.withdraw_limit || 0;
                    const withdrawMin = d.withdraw_min || 0;
                    const withdrawMax = d.withdraw_max || 0;
                    const isInvite = d.invite_allow !== undefined ? d.invite_allow : true;

                    const inviteBtnClass = isInvite ? 'bg-cyan-500 hover:bg-cyan-600' : 'bg-gray-400 hover:bg-gray-500';
                    const inviteText = isInvite ? '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' : '‡∏õ‡∏¥‡∏î';

                    // Icon Logic
                    let iconDisplay = '';
                    if (d.icon && (d.icon.startsWith('http') || d.icon.startsWith('https'))) {
                        iconDisplay = `<img src="${d.icon}" class="w-8 h-8 mx-auto object-contain drop-shadow-sm">`;
                    } else if (d.icon) {
                        iconDisplay = `<i class="${d.icon} text-2xl drop-shadow-sm"></i>`;
                    } else {
                        iconDisplay = '<i class="fa-solid fa-crown text-gray-300 text-2xl"></i>';
                    }

                    const row = `
                        <tr class="border-b last:border-b-0 hover:bg-gray-50">
                            <td class="text-gray-500">${index++}</td>
                            <td class="text-left font-bold text-gray-700">${d.name}</td>
                            <td class="p-2">${iconDisplay}</td>
                            <td class="text-right font-bold text-orange-600">‡∏ø${Number(d.price).toLocaleString()}</td>
                            <td class="text-gray-600">${Number(d.rate).toFixed(4)}</td>
                            <td class="text-gray-500 text-[10px]">${d.tier_rate || '0/0/0'}</td>
                            <td class="text-gray-600 font-bold">${Number(minBal).toLocaleString()}</td>
                            <td class="text-gray-800 font-bold">${orderCount}</td>
                            <td>${withdrawLimit}</td>
                            <td>${Number(withdrawMin).toLocaleString()}</td>
                            <td>${Number(withdrawMax).toLocaleString()}</td>
                            <td>
                                <button onclick="toggleInvite('${docId}', ${isInvite})" class="${inviteBtnClass} text-white px-2 py-1 rounded text-[10px] w-14 transition">
                                    ${inviteText}
                                </button>
                            </td>
                            <td>
                                <button onclick="openEditModal('${docId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-[10px] shadow transition flex items-center gap-1 mx-auto">
                                    <i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            });
        }

        window.openEditModal = (docId) => {
            const level = allLevels.find(l => l.docId === docId);
            if (!level) return;

            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-name').value = level.name;
            document.getElementById('edit-price').value = level.price;
            document.getElementById('edit-rate').value = level.rate;
            document.getElementById('edit-ref-rate').value = level.tier_rate || "0/0/0";
            
            // Map ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB
            document.getElementById('edit-min-bal').value = level.min_bal || 0;
            document.getElementById('edit-orders').value = level.orders || 0;
            document.getElementById('edit-withdraw-count').value = level.withdraw_limit || 0;
            document.getElementById('edit-min-withdraw').value = level.withdraw_min || 0;
            document.getElementById('edit-max-withdraw').value = level.withdraw_max || 0;
            
            document.getElementById('edit-icon').value = level.icon || "";

            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeEditModal = () => {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.saveLevelChanges = async () => {
            const docId = document.getElementById('edit-doc-id').value;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Field ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (min_bal, orders ‡∏Ø‡∏•‡∏Ø)
            const updateData = {
                name: document.getElementById('edit-name').value,
                price: parseFloat(document.getElementById('edit-price').value) || 0,
                rate: parseFloat(document.getElementById('edit-rate').value) || 0,
                tier_rate: document.getElementById('edit-ref-rate').value,
                
                min_bal: parseFloat(document.getElementById('edit-min-bal').value) || 0, // ‡∏ï‡∏£‡∏á DB
                orders: parseInt(document.getElementById('edit-orders').value) || 0,      // ‡∏ï‡∏£‡∏á DB
                withdraw_limit: parseInt(document.getElementById('edit-withdraw-count').value) || 0, // ‡∏ï‡∏£‡∏á DB
                withdraw_min: parseFloat(document.getElementById('edit-min-withdraw').value) || 0,   // ‡∏ï‡∏£‡∏á DB
                withdraw_max: parseFloat(document.getElementById('edit-max-withdraw').value) || 0,   // ‡∏ï‡∏£‡∏á DB
                
                icon: document.getElementById('edit-icon').value.trim()
            };

            try {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà collection "levels"
                await db.collection("levels").doc(docId).update(updateData);
                closeEditModal();
            } catch (e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            }
        }

        window.toggleInvite = async (docId, currentStatus) => {
            try {
                await db.collection("levels").doc(docId).update({ invite_allow: !currentStatus });
            } catch (e) { console.error(e); }
        }

        fetchLevels();
    </script>
</body>
</html>