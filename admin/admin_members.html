<!DOCTYPE html>
<html lang="th">
<head>
<script>
    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Security Check) ---
    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤ 'admin_logged_in' ‡πÄ‡∏õ‡πá‡∏ô 'true'
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        // ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡∏≠‡∏¢‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ 1 ‡∏Ç‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ admin_login)
        window.location.href = '../admin_login/index.html';
    }
</script>

    <meta charset="UTF-8">
    <title>Admin - ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="js/admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ */
.table-wrapper { 
    overflow-x: auto; 
    white-space: nowrap; 
    padding-bottom: 20px; /* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô */
    
}
        th, td { padding: 12px 10px; font-size: 11px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; text-align: center; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        tr:hover { background-color: #f8fafc; transition: 0.2s; }
        .btn-action { padding: 4px 8px; border-radius: 4px; font-size: 10px; color: white; margin: 0 2px; transition: 0.2s; }
        .btn-inject { background-color: #ef4444; } .btn-orders { background-color: #0ea5e9; } .btn-level { background-color: #f59e0b; } .btn-reset { background-color: #64748b; } 
        .btn-action:hover { opacity: 0.8; transform: scale(1.05); }
        .modal-scale-in { animation: scaleIn 0.2s ease-out forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <script src="js/admin_ui.js"></script>
    <script src="js/firebase_setup.js"></script> 

    <script>
        renderAdminUI('members', 'list'); 

        // 1. ‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô main-content ‡πÄ‡∏î‡∏¥‡∏°
       // ‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-5 shadow-sm border-b flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Member List)</h2>
                <div class="flex gap-2">
                    <button onclick="openAddMemberModal()" class="bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded text-xs hover:bg-gray-50 font-bold shadow-sm transition">
                        <i class="fa-solid fa-user-plus text-green-500"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 mx-4">
                <div class="flex gap-2">
                    <input type="text" id="search-input" onkeyup="renderTable(true)" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="border px-3 py-2 text-xs rounded w-64 focus:outline-none focus:border-indigo-500">
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded text-xs shadow hover:bg-indigo-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mx-4 flex flex-col mb-10">
                <div class="table-wrapper custom-scroll flex-1">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th><input type="checkbox"></th>
                                <th>‡πÑ‡∏≠‡∏î‡∏µ</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</th>
                                <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç</th>
                                <th class="text-right text-green-600">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø (Comm)</th>
                                <th class="text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</th>
                                <th class="text-right text-red-500">‡∏¢‡∏≠‡∏î‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á</th> 
                                <th class="text-right text-blue-600">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</th> 
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</th> 
                                <th class="text-red-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</th>
                                <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <tr><td colspan="15" class="text-center p-12 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="p-4 border-t bg-gray-50 flex justify-between items-center text-xs rounded-b-xl">
                    <div class="text-gray-500">
                        ‡πÅ‡∏™‡∏î‡∏á <span id="show-start" class="font-bold">0</span> ‡∏ñ‡∏∂‡∏á <span id="show-end" class="font-bold">0</span> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="show-total" class="font-bold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="flex gap-2">
                        <button onclick="changePage(-1)" id="btn-prev-page" class="px-3 py-1.5 bg-white border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed font-bold text-gray-600 shadow-sm">
                            <i class="fa-solid fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        </button>
                        <span id="page-indicator" class="px-3 py-1.5 bg-white border rounded font-bold text-indigo-600 shadow-sm">
                            ‡∏´‡∏ô‡πâ‡∏≤ 1
                        </span>
                        <button onclick="changePage(1)" id="btn-next-page" class="px-3 py-1.5 bg-white border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed font-bold text-gray-600 shadow-sm">
                            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Modals Code (Add Member, Level, History) - ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
        const modalAddHtml = `<div id="modal-add-member" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm font-sans"><div class="bg-white rounded-lg shadow-2xl w-full max-w-lg modal-scale-in overflow-hidden"><div class="flex justify-between items-center p-4 border-b"><h3 class="font-bold text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3><button onclick="closeModal('modal-add-member')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button></div><div class="p-6 space-y-4"><div class="flex items-center gap-4"><label class="w-32 text-right text-xs font-bold text-gray-600">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1</label><select id="add-agent" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 bg-gray-50"><option value="platform">Platform (Admin)</option></select></div><div class="flex items-center gap-4"><label class="w-32 text-right text-xs font-bold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input type="text" id="add-username" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"></div><div class="flex items-center gap-4"><label class="w-32 text-right text-xs font-bold text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label><div class="flex-1 flex border border-gray-300 rounded overflow-hidden"><select id="add-country-code" class="bg-gray-50 px-2 py-2 text-sm border-r border-gray-300 focus:outline-none font-bold text-gray-700 cursor-pointer"><option value="+66">üáπüá≠ +66</option><option value="+856">üá±üá¶ +856</option><option value="+95">üá≤üá≤ +95</option><option value="+84">üáªüá≥ +84</option><option value="+855">üá∞üá≠ +855</option><option value="+60">üá≤üáæ +60</option><option value="+99">üè≥Ô∏è +99</option></select><input type="tel" id="add-phone" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" class="flex-1 px-3 py-2 text-sm focus:outline-none"></div></div><div class="flex items-center gap-4"><label class="w-32 text-right text-xs font-bold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô <span class="text-red-500">*</span></label><input type="text" id="add-password" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"></div><div class="flex items-center gap-4"><label class="w-32 text-right text-xs font-bold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</label><input type="text" id="add-upline" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"></div></div><div class="bg-gray-50 p-4 flex justify-center gap-3 border-t"><button onclick="saveNewMember()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button onclick="closeModal('modal-add-member')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalAddHtml);

        const modalLevelHtml = `
<div id="modal-level" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg modal-scale-in overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="font-bold text-gray-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button onclick="closeModal('modal-level')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <input type="hidden" id="edit-lvl-uid">
            
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <input type="text" id="edit-lvl-balance-show" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm bg-gray-100 text-gray-500 font-bold" disabled>
            </div>

            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-green-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (+)</label>
                <input type="number" id="edit-lvl-add-balance" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 500)" class="flex-1 border border-green-500 rounded px-3 py-2 text-sm focus:outline-none focus:border-green-700 text-green-700 font-bold">
            </div>

            <hr class="border-gray-200">

            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="text-red-500">*</span></label>
                <select id="edit-lvl-select" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"></select>
            </div>
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå <span class="text-red-500">*</span></label>
                <select id="edit-lvl-overlay" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
                    <option value="none">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (None)</option>
                    <option value="group_a">Group A</option>
                    <option value="group_b">Group B</option>
                </select>
            </div>
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                <input type="number" id="edit-lvl-orders" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
            </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t">
            <button onclick="saveLevel()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î</button>
            <button onclick="closeModal('modal-level')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>`;
        document.body.insertAdjacentHTML('beforeend', modalLevelHtml);

        const modalHistoryHtml = `
        <div id="modal-history" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl p-6 modal-scale-in h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-gray-800"><i class="fa-solid fa-syringe text-red-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î (‡∏â‡∏µ‡∏î)</h3>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="openInjectionModal()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow transition">
                            <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î
                        </button>
                        <button onclick="closeModal('modal-history')" class="text-gray-400 hover:text-gray-600 ml-2"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-100 text-xs text-gray-600">
                                <th class="p-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th class="p-2 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="p-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-2">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="p-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="text-xs"></tbody>
                    </table>
                </div>
            </div>
        </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHistoryHtml);
        // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏•‡∏ö document.body.insertAdjacentHTML ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
        // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÑ‡∏õ ‡∏Å‡πá‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

        // --- LOGIC ---
        let allUsers = [];
        let frozenMap = {}; // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î Frozen ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
        let levelMap = {};
        // --- 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ User ‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô ---
        let currentTargetUserId = null; 

        // --- 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° HTML Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ "‡∏â‡∏µ‡∏î" (Inject) ---
        // (‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å modalHistoryHtml ‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏ñ‡∏ß‡πÜ modal ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô HTML ‡∏Ç‡∏≠‡∏á Modal ‡∏â‡∏µ‡∏î ---
const modalInjectHtml = `
<div id="modal-inject" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-scale-in overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="font-bold text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î / ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (Trap)</h3>
            <button onclick="closeModal('modal-inject')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto custom-scroll">
            
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</label>
                <select id="inj-type" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
                    <option value="deposit">‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Deposit)</option>
                    <option value="withdraw">‚ûñ ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (Withdraw)</option>
                </select>
            </div>
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                <input type="number" id="inj-amount" placeholder="0.00" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
            </div>
            <div class="flex items-center gap-4">
                <label class="w-32 text-right text-xs font-bold text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <input type="text" id="inj-memo" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
            </div>

            <div class="bg-purple-50 p-3 rounded border border-purple-100">
                <div class="flex items-center gap-4">
                    <label class="w-32 text-right text-xs font-bold text-purple-700">‚ö° ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø (x)</label>
                    <input type="number" id="inj-multiplier" placeholder="‡∏õ‡∏Å‡∏ï‡∏¥ = 1" step="0.1" class="flex-1 border border-purple-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500 text-purple-700 font-bold bg-white">
                </div>
            </div>

            <div class="bg-red-50 p-3 rounded border border-red-200 mt-2">
                <div class="flex items-center gap-2 mb-2 border-b border-red-200 pb-1">
                    <i class="fa-solid fa-bomb text-red-600"></i>
                    <span class="text-xs font-bold text-red-700">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ï‡∏¥‡∏î‡∏•‡∏ö (Negative Trap)</span>
                </div>
                
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-600 mb-1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà:</label>
                        <input type="number" id="inj-trap-round" placeholder="‡πÄ‡∏ä‡πà‡∏ô 9" class="w-full border border-red-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500 text-red-700 font-bold bg-white">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-600 mb-1">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏ö:</label>
                        <input type="number" id="inj-trap-amount" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10000" class="w-full border border-red-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500 text-red-700 font-bold bg-white">
                    </div>
                </div>
                <p class="text-[10px] text-red-500 mt-2">
                    * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏¢‡∏≠‡∏î Frozen ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏•‡∏ö
                </p>
            </div>

        </div>
        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t">
            <button onclick="saveInjection()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</button>
            <button onclick="closeModal('modal-inject')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalInjectHtml);
        // --- 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° HTML Modal ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Settings) ---
        const modalOrderSettingsHtml = `
        <div id="modal-order-settings" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm font-sans">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-scale-in overflow-hidden">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                    <h3 class="font-bold text-gray-700"><i class="fa-solid fa-gear text-blue-500"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                    <button onclick="closeModal('modal-order-settings')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Target)</label>
                        <div class="flex items-center border border-gray-300 rounded px-3 py-2 bg-white">
                            <input type="number" id="set-target-orders" placeholder="0" class="flex-1 text-sm focus:outline-none text-gray-700 font-bold">
                            <span class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">üí∏ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (Custom Rate)</label>
                        <div class="flex items-center border border-gray-300 rounded px-3 py-2 bg-white">
                            <input type="number" id="set-commission" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.2000" step="0.0001" class="flex-1 text-sm focus:outline-none text-gray-700 font-bold">
                            <span class="text-xs text-gray-400">%</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏£‡∏ó‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö VIP</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">üè¶ ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Withdraw Limit)</label>
                        <div class="flex items-center border border-gray-300 rounded px-3 py-2 bg-white">
                            <input type="number" id="set-withdraw-limit" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" class="flex-1 text-sm focus:outline-none text-gray-700 font-bold">
                            <span class="text-xs text-gray-400">‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">üìâ ‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (Minimum Withdraw)</label>
                        <div class="flex items-center border border-gray-300 rounded px-3 py-2 bg-white">
                            <span class="text-xs text-gray-400 mr-1">‡∏ø</span>
                            <input type="number" id="set-min-withdraw" placeholder="0.00" class="flex-1 text-sm focus:outline-none text-gray-700 font-bold">
                        </div>
                    </div>

                </div>
                <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t">
                    <button onclick="saveOrderSettings()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                    <button onclick="closeModal('modal-order-settings')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded text-sm font-bold shadow">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalOrderSettingsHtml);
        async function initData() {
            if (!window.db) return setTimeout(initData, 1000);
            
            // ‡πÇ‡∏´‡∏•‡∏î Levels
            // ‡πÇ‡∏´‡∏•‡∏î Levels ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô
const levelsSnap = await db.collection("levels").orderBy("price", "asc").get();
const levelSelect = document.getElementById('edit-lvl-select');
levelSelect.innerHTML = '';

levelMap = {}; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤

levelsSnap.forEach(doc => { 
    const data = doc.data();
    
    // ‚úÖ ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ô DB ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡πà‡∏≤ orders ‡∏´‡∏£‡∏∑‡∏≠ task_count)
    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á data.orders ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö
    levelMap[data.name] = data.orders || 0; 

    const option = document.createElement('option'); 
    option.value = data.name; 
    option.innerText = data.name; 
    levelSelect.appendChild(option); 
});

            // ‚úÖ 1. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà Frozen ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≠‡πÑ‡∏ß‡πâ
            db.collection("orders").where("status", "==", "frozen").onSnapshot(snap => {
                frozenMap = {}; // Reset
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.username && d.amount) {
                        // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î Frozen ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Username
                        frozenMap[d.username] = (frozenMap[d.username] || 0) + parseFloat(d.amount);
                    }
                });
                renderTable(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î Frozen ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            });

            // ‚úÖ 2. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users
            db.collection("users").onSnapshot(snap => {
                allUsers = [];
                snap.forEach(doc => allUsers.push({ docId: doc.id, ...doc.data() }));
                renderTable();
            });
        }

        // 2. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
        let currentPage = 1;
        const itemsPerPage = 10; // ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ
        let filteredUsers = [];

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderTable ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°)
        function renderTable(isSearch = false) {
            const tbody = document.getElementById('users-body');
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            const now = new Date(); 

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 1
            if (isSearch) {
                currentPage = 1;
            }

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ filteredUsers
            filteredUsers = allUsers.filter(u => {
                return !searchVal || u.username.toLowerCase().includes(searchVal) || u.phone.includes(searchVal);
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
            filteredUsers.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

            // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ ---
            const totalItems = filteredUsers.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
            
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            
            // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const usersToShow = filteredUsers.slice(startIndex, endIndex);
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---

            let html = '';
            usersToShow.forEach(u => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Online/Offline
                let statusHtml = '<span class="px-2 py-0.5 rounded text-[10px] bg-gray-100 text-gray-400">‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
                if (u.last_active) {
                    const diffMinutes = (now - new Date(u.last_active)) / 1000 / 60; 
                    if (diffMinutes < 2) statusHtml = '<span class="px-2 py-0.5 rounded text-[10px] bg-green-100 text-green-700 font-bold">Online</span>';
                    else statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] bg-gray-100 text-gray-500">Offline</span>`;
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô
                const totalComm = parseFloat(u.commission || 0);
                const totalBalance = parseFloat(u.balance || 0);
                const frozenAmount = frozenMap[u.username] || 0;
                const availableBalance = totalBalance - frozenAmount;

                html += `
                    <tr class="border-b last:border-b-0 hover:bg-gray-50 transition">
                        <td><input type="checkbox"></td>
                        <td>${u.id || '-'}</td>
                        <td class="text-gray-500 text-[10px]">${u.created_at ? new Date(u.created_at).toLocaleString('th-TH') : '-'}</td>
                        <td>${u.phone || '-'}</td>
                        <td class="font-bold text-blue-600">${u.username}</td>
                        <td><span class="px-2 py-0.5 rounded text-[10px] border font-bold text-purple-600 bg-purple-50 border-purple-100">${u.level || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</span></td>
                        <td>${u.todayCount || 0}/${levelMap[u.level] || 0}</td>
                        <td class="font-mono text-gray-500">${u.invite_code || '-'}</td>
                        <td class="text-right font-bold text-green-500">+${totalComm.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                        <td class="text-right font-bold text-gray-700">${totalBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                        <td class="text-right font-bold text-red-500">${frozenAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</td> 
                        <td class="text-right font-bold text-blue-600">${availableBalance.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                        <td>${statusHtml}</td>
                        <td class="text-xs text-red-500 font-bold truncate" title="${u.admin_memo || ''}">${u.admin_memo ? `<i class="fa-solid fa-note-sticky"></i>` : '-'}</td>
                        <td class="flex justify-center py-2">
                            <button onclick="openHistory('${u.docId}')" class="btn-action btn-inject">‡∏â‡∏µ‡∏î</button>
                            <button onclick="resetUserTasks('${u.docId}')" class="btn-action btn-reset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                            <button onclick="openOrderSettings('${u.docId}')" class="btn-action btn-orders">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                            <button onclick="openLevelEdit('${u.docId}')" class="btn-action btn-level">‡∏£‡∏∞‡∏î‡∏±‡∏ö</button>
                            <button onclick="toggleActionMenu(event, '${u.docId}')" class="bg-white text-gray-500 hover:text-indigo-600 border w-7 h-7 rounded ml-1 flex items-center justify-center"><i class="fa-solid fa-chevron-down text-[10px]"></i></button>
                        </td>
                    </tr>`;
            });

            tbody.innerHTML = html || '<tr><td colspan="15" class="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</td></tr>';
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            updatePaginationControls(totalItems, totalPages, startIndex, usersToShow.length);
        }

        // 4. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Add new functions)
        function changePage(direction) {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage) || 1;
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function updatePaginationControls(totalItems, totalPages, startIndex, countShown) {
            document.getElementById('show-start').innerText = totalItems === 0 ? 0 : startIndex + 1;
            document.getElementById('show-end').innerText = startIndex + countShown;
            document.getElementById('show-total').innerText = totalItems;
            document.getElementById('page-indicator').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}`;

            document.getElementById('btn-prev-page').disabled = (currentPage === 1);
            document.getElementById('btn-next-page').disabled = (currentPage === totalPages || totalItems === 0);
        }
        window.openAddMemberModal = () => { document.getElementById('add-username').value = ''; document.getElementById('add-phone').value = ''; document.getElementById('add-password').value = ''; document.getElementById('add-upline').value = ''; const modal = document.getElementById('modal-add-member'); modal.classList.remove('hidden'); modal.classList.add('flex'); }
        window.saveNewMember = async () => { const username = document.getElementById('add-username').value.trim(); const countryCode = document.getElementById('add-country-code').value; let phoneBody = document.getElementById('add-phone').value.trim(); const password = document.getElementById('add-password').value.trim(); const upline = document.getElementById('add-upline').value.trim() || 'admin'; if(!phoneBody || !password) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"); return; } if (phoneBody.startsWith('0')) { phoneBody = phoneBody.substring(1); } const fullPhone = `${countryCode} ${phoneBody}`; try { const check = await db.collection("users").where("phone", "==", fullPhone).get(); if(!check.empty) { alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); return; } const randomId = Math.floor(100000 + Math.random() * 900000); const randomInvite = Math.floor(100000 + Math.random() * 900000).toString(); 
        await db.collection("users").add({ username: username || phoneBody, phone: fullPhone, password: password, upline: upline, balance: 150, level: "VIP 1", id: randomId, invite_code: randomInvite, created_at: new Date().toISOString(), todayCount: 0, online: false,random_qty_min: 1, 
                    random_qty_max: 300 });
         closeModal('modal-add-member'); alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç: ${randomInvite})`); } catch(e) { alert("Error: " + e.message); } }
        window.openLevelEdit = (docId) => { 
    const user = allUsers.find(u => u.docId === docId); 
    if (!user) return; 

    document.getElementById('edit-lvl-uid').value = docId; 
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
    document.getElementById('edit-lvl-select').value = user.level || 'VIP 1'; 
    document.getElementById('edit-lvl-overlay').value = user.overlay_group || 'none'; 
    document.getElementById('edit-lvl-orders').value = user.todayCount || 0; 

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
    document.getElementById('edit-lvl-balance-show').value = parseFloat(user.balance || 0).toLocaleString();
    document.getElementById('edit-lvl-add-balance').value = '';

    const modal = document.getElementById('modal-level'); 
    modal.classList.remove('hidden'); 
    modal.classList.add('flex'); 
}
        window.saveLevel = async () => { 
    const docId = document.getElementById('edit-lvl-uid').value; 
    const addAmount = parseFloat(document.getElementById('edit-lvl-add-balance').value) || 0;

    try { 
        let updateData = { 
            level: document.getElementById('edit-lvl-select').value, 
            overlay_group: document.getElementById('edit-lvl-overlay').value, 
            todayCount: parseInt(document.getElementById('edit-lvl-orders').value) || 0 
        };

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°
        if (addAmount !== 0) {
            // 1. ‡∏ö‡∏ß‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ User
            updateData.balance = firebase.firestore.FieldValue.increment(addAmount);

            // 2. (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Dashboard ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
            await db.collection("recharges").add({
                user_id: docId,
                amount: addAmount,
                status: 'approved',        // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ approved Dashboard ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ô‡∏±‡∏ö
                timestamp: new Date().toISOString(),
                method: 'admin_manual',    // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ
                username: 'Admin Inject'   // ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            });
        }

        await db.collection("users").doc(docId).update(updateData); 
        if (addAmount > 0) {
            await checkAndUnlockFrozenOrders(docId);
        }
        closeModal('modal-level'); 
        
        if(addAmount !== 0) {
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +${addAmount.toLocaleString()} ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß`);
        } else {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
        
    } catch(e) { 
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); 
    } 
}
       // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÉ‡∏´‡πâ‡∏à‡∏≥ User ID)
        window.openHistory = async (docId) => { 
            currentTargetUserId = docId; // ‚úÖ ‡∏à‡∏≥ ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ß‡πâ
            document.getElementById('history-body').innerHTML = '<tr><td colspan="5" class="text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>'; 
            
            const modal = document.getElementById('modal-history'); 
            modal.classList.remove('hidden'); 
            modal.classList.add('flex'); 
            
            await renderHistoryTable(docId); // ‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
        async function renderHistoryTable(docId) {
            let html = ''; 
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Recharges)
            const rSnap = await db.collection("recharges").where("user_id", "==", docId).orderBy("timestamp", "desc").limit(20).get(); 
            rSnap.forEach(d => { 
                const data = d.data();
                html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 text-green-600 font-bold">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏â‡∏µ‡∏î</td>
                    <td class="p-2 text-right text-green-600 font-bold">+${Number(data.amount).toLocaleString()}</td>
                    <td class="p-2 text-center"><span class="bg-green-100 text-green-800 px-2 rounded-full text-[10px]">${data.status}</span></td>
                    <td class="p-2 text-gray-500 text-[10px]">${new Date(data.timestamp).toLocaleString()}</td>
                    <td class="p-2 text-center flex justify-center gap-2">
                        <button onclick="editTx('recharges', '${d.id}', ${data.amount})" class="text-blue-500 hover:text-blue-700 bg-blue-50 p-1 rounded"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delTx('recharges', '${d.id}', ${data.amount}, 'plus')" class="text-red-500 hover:text-red-700 bg-red-50 p-1 rounded"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Withdrawals)
            const wSnap = await db.collection("withdrawals").where("user_id", "==", docId).orderBy("timestamp", "desc").limit(20).get(); 
            wSnap.forEach(d => { 
                const data = d.data();
                html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 text-red-600 font-bold">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/‡∏´‡∏±‡∏Å</td>
                    <td class="p-2 text-right text-red-600 font-bold">-${Number(data.amount).toLocaleString()}</td>
                    <td class="p-2 text-center"><span class="bg-gray-100 text-gray-800 px-2 rounded-full text-[10px]">${data.status}</span></td>
                    <td class="p-2 text-gray-500 text-[10px]">${new Date(data.timestamp).toLocaleString()}</td>
                    <td class="p-2 text-center flex justify-center gap-2">
                        <button onclick="editTx('withdrawals', '${d.id}', ${data.amount})" class="text-blue-500 hover:text-blue-700 bg-blue-50 p-1 rounded"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delTx('withdrawals', '${d.id}', ${data.amount}, 'minus')" class="text-red-500 hover:text-red-700 bg-red-50 p-1 rounded"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 

            document.getElementById('history-body').innerHTML = html || '<tr><td colspan="5" class="text-center p-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</td></tr>';
        }
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô (Reset Tasks) ---
window.resetUserTasks = async (docId) => {
    // 1. ‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    if(confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï?\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? \n(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0)')) {
        try {
            // 2. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase
            await db.collection("users").doc(docId).update({
                todayCount: 0
            });
            
            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
            alert('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            
            // (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderTable() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ onSnapshot ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        } catch(e) {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
        }
    }
}
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏â‡∏µ‡∏î
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ---
window.openInjectionModal = () => {
    if(!currentTargetUserId) return;

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏â‡∏µ‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    document.getElementById('inj-amount').value = '';
    document.getElementById('inj-memo').value = '';
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const user = allUsers.find(u => u.docId === currentTargetUserId);
    
    // 1. ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡πÄ‡∏î‡∏¥‡∏°
    const currentMultiplier = user && user.commission_multiplier ? user.commission_multiplier : '';
    document.getElementById('inj-multiplier').value = currentMultiplier;

    // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (user && user.trap_config) {
        document.getElementById('inj-trap-round').value = user.trap_config.trigger_round || '';
        document.getElementById('inj-trap-amount').value = user.trap_config.trap_amount || '';
    } else {
        document.getElementById('inj-trap-round').value = '';
        document.getElementById('inj-trap-amount').value = '';
    }

    const modal = document.getElementById('modal-inject');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î (Save Injection)
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î (Save Injection)
        window.saveInjection = async () => {
            if(!currentTargetUserId) return;
            
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏â‡∏µ‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
            const type = document.getElementById('inj-type').value;
            const amountStr = document.getElementById('inj-amount').value;
            const memo = document.getElementById('inj-memo').value;
            
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á
            const multiplierStr = document.getElementById('inj-multiplier').value;
            const trapRoundStr = document.getElementById('inj-trap-round').value;
            const trapAmountStr = document.getElementById('inj-trap-amount').value;

            const amount = parseFloat(amountStr);
            const multiplier = parseFloat(multiplierStr);
            const trapRound = parseInt(trapRoundStr);
            const trapAmount = parseFloat(trapAmountStr);

            try {
                let updateData = {}; 
                let message = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ";

                // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì"
                if (!isNaN(multiplier)) {
                    updateData.commission_multiplier = multiplier;
                    message += `‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì x${multiplier} `;
                }

                // 2. üî¥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (Trap)" -> ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                if (!isNaN(trapRound) && !isNaN(trapAmount) && trapRound > 0 && trapAmount > 0) {
                    updateData.trap_config = {
                        trigger_round: trapRound,  
                        trap_amount: trapAmount,   
                        is_triggered: false,
                        
                        // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!) ‚úÖ‚úÖ‚úÖ
                        active: true 
                    };
                    message += `| ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${trapRound} ‡∏¢‡∏≠‡∏î ${trapAmount.toLocaleString()} `;
                } else if (trapRoundStr === '' && trapAmountStr === '') {
                    // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å
                    updateData.trap_config = firebase.firestore.FieldValue.delete();
                }

                // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏â‡∏µ‡∏î‡πÄ‡∏á‡∏¥‡∏ô/‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô" (‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
                let isFinancialTx = false;
                if (!isNaN(amount) && amount > 0) {
                    isFinancialTx = true;
                    const txData = {
                        user_id: currentTargetUserId,
                        amount: amount,
                        status: 'approved',
                        timestamp: new Date().toISOString(),
                        method: 'admin_injection',
                        memo: memo || 'Admin Manual Inject'
                    };

                    if (type === 'deposit') {
                        await db.collection("recharges").add(txData);
                        updateData.balance = firebase.firestore.FieldValue.increment(amount);
                        message += `| ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô +${amount.toLocaleString()} `;
                    } else {
                        await db.collection("withdrawals").add(txData);
                        updateData.balance = firebase.firestore.FieldValue.increment(-amount);
                        message += `| ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô -${amount.toLocaleString()} `;
                    }
                }

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
                if (!isFinancialTx && Object.keys(updateData).length === 0) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏á‡∏¥‡∏ô, ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì, ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å)");
                    return;
                }

                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Database
                await db.collection("users").doc(currentTargetUserId).update(updateData);
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏´‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤)
                await checkAndUnlockFrozenOrders(currentTargetUserId);
                
                closeModal('modal-inject');
                await renderHistoryTable(currentTargetUserId); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                
                alert(message);

            } catch(e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
                console.error(e);
            }
        }
        // 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        window.openOrderSettings = (docId) => {
            currentTargetUserId = docId;
            const user = allUsers.find(u => u.docId === docId);
            if (!user) return;

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠ 0)
            document.getElementById('set-target-orders').value = user.req_orders || '';      // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            document.getElementById('set-commission').value = user.custom_rate || '';        // ‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©
            document.getElementById('set-withdraw-limit').value = user.withdraw_limit || ''; // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ñ‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            document.getElementById('set-min-withdraw').value = user.min_withdraw || '';     // ‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥

            const modal = document.getElementById('modal-order-settings');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // 8. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Save Settings)
        window.saveOrderSettings = async () => {
            if (!currentTargetUserId) return;

            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const reqOrders = parseInt(document.getElementById('set-target-orders').value) || 0;
            const customRate = parseFloat(document.getElementById('set-commission').value) || 0;
            const withdrawLimit = parseInt(document.getElementById('set-withdraw-limit').value) || 0;
            const minWithdraw = parseFloat(document.getElementById('set-min-withdraw').value) || 0;

            try {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô User Document ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                await db.collection("users").doc(currentTargetUserId).update({
                    req_orders: reqOrders,         // ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏Å‡∏µ‡πà‡∏á‡∏≤‡∏ô
                    custom_rate: customRate,       // ‡πÄ‡∏£‡∏ó‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (0 = ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö)
                    withdraw_limit: withdrawLimit, // ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (0 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)
                    min_withdraw: minWithdraw,     // ‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Timestamp ‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏î‡∏π)
                    settings_updated_at: new Date().toISOString()
                });

                closeModal('modal-order-settings');
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                
                // (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                // renderTable(); 

            } catch(e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            }
        }

        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î (Edit Transaction)
        window.editTx = async (collectionName, docId, oldAmount) => {
            const newAmountStr = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:", oldAmount);
            if (newAmountStr === null) return; // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            
            const newAmount = parseFloat(newAmountStr);
            if (isNaN(newAmount) || newAmount < 0) {
                alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            try {
                // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
                const diff = newAmount - oldAmount; // ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å 100 ‡πÄ‡∏õ‡πá‡∏ô 150 -> diff = 50
                
                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô Transaction
                await db.collection(collectionName).doc(docId).update({
                    amount: newAmount,
                    memo: 'Edited by Admin'
                });

                // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ User ‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô recharges (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤) -> ‡∏ö‡∏ß‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô withdrawals (‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å) -> ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô = balance ‡∏•‡∏î‡∏•‡∏á)
                let balanceChange = 0;
                if (collectionName === 'recharges') {
                    balanceChange = diff; 
                } else {
                    balanceChange = -diff;
                }

                if (balanceChange !== 0) {
                    await db.collection("users").doc(currentTargetUserId).update({
                        balance: firebase.firestore.FieldValue.increment(balanceChange)
                    });
                }

                await renderHistoryTable(currentTargetUserId);
                alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢)
        window.delTx = async (col, id, amount, type) => { 
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { 
                try {
                    await db.collection(col).doc(id).delete();
                    
                    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Reverse Balance)
                    let reverseAmount = 0;
                    if (type === 'plus') {
                        // ‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô -> ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÄ‡∏á‡∏¥‡∏ô User ‡∏≠‡∏≠‡∏Å
                        reverseAmount = -amount;
                    } else {
                        // ‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -> ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ User
                        reverseAmount = amount;
                    }

                    await db.collection("users").doc(currentTargetUserId).update({
                        balance: firebase.firestore.FieldValue.increment(reverseAmount)
                    });

                    await renderHistoryTable(currentTargetUserId);
                    alert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                } catch(e) {
                    alert("Error: " + e.message);
                }
            } 
        }
        window.closeModal = (id) => { const el = document.getElementById(id); el.classList.add('hidden'); el.classList.remove('flex'); }

        initData();
// --- Modal ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (More Actions) ---
// --- Popover Menu (‡πÄ‡∏°‡∏ô‡∏π‡∏™‡πÑ‡∏•‡∏î‡πå) ---
// --- Popover Menu ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Button Grid) ---
const popoverMenuHtml = `
<div id="action-popover" class="fixed z-[100] hidden bg-white rounded-xl shadow-[0_4px_20px_rgba(0,0,0,0.15)] border border-gray-100 p-3 max-w-2xl transform transition-all duration-300 origin-top-right scale-95 opacity-0">
    
    <button onclick="closeActionMenu()" class="absolute -top-3 -right-3 bg-gray-500 hover:bg-gray-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md text-xs transition">
        <i class="fa-solid fa-xmark"></i>
    </button>

    <div class="flex flex-wrap gap-2 items-center">
        
        <button onclick="openInjectionModal()" class="px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-[10px] font-bold shadow-sm">‡∏â‡∏µ‡∏î</button>
        <button onclick="resetUserTasks(currentActionUserId)" class="px-2 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold shadow-sm">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô</button>
        
        <button onclick="alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')" class="px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-[10px] font-bold shadow-sm">‡πÇ‡∏Ñ‡πâ‡∏î</button>
        
        <button onclick="openLevelEdit(currentActionUserId)" class="px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-bold shadow-sm">‡∏£‡∏∞‡∏î‡∏±‡∏ö</button>
        
        <button onclick="openEditBalanceModal(currentActionUserId)" class="px-2 py-1 rounded bg-blue-700 hover:bg-blue-800 text-white text-[10px] font-bold shadow-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
   <button id="btn-invite-status" onclick="toggleInviteCodeStatus(currentActionUserId)" class="px-2 py-1 rounded text-white text-[10px] font-bold shadow-sm transition">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</button>
        <button onclick="openManageUserModal(currentActionUserId)" class="px-2 py-1 rounded bg-teal-600 hover:bg-teal-700 text-white text-[10px] font-bold shadow-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
        
        <button onclick="openBankInfoModal(currentActionUserId)" class="px-2 py-1 rounded bg-teal-600 hover:bg-teal-700 text-white text-[10px] font-bold shadow-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
        <button onclick="alert('‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà')" class="px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-bold shadow-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
        <button onclick="alert('‡∏î‡∏π‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô')" class="px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-bold shadow-sm">‡∏î‡∏π‡∏ó‡∏µ‡∏°</button>

        <button onclick="openFullUserHistory(currentActionUserId)" class="px-2 py-1 rounded bg-cyan-600 hover:bg-cyan-700 text-white text-[10px] font-bold shadow-sm">
    <i class="fa-solid fa-clock-rotate-left mr-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
</button>
        
<button onclick="askDeleteUser(currentActionUserId)" class="px-2 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold shadow-sm">
    <i class="fa-solid fa-trash mr-1"></i> ‡∏•‡∏ö
</button>

<button id="btn-ban-user" onclick="askBanUser(currentActionUserId)" class="px-2 py-1 rounded bg-gray-600 hover:bg-gray-700 text-white text-[10px] font-bold shadow-sm">
    <i class="fa-solid fa-ban mr-1"></i> ‡∏£‡∏∞‡∏á‡∏±‡∏ö
</button>
        
        
        <button id="btn-suspend-order" onclick="askToggleOrderSuspension(currentActionUserId)" class="px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-bold shadow-sm">
    <i class="fa-solid fa-pause mr-1"></i> ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
</button>
        <button onclick="openMemoModal(currentActionUserId)" class="px-2 py-1 rounded bg-purple-500 hover:bg-purple-600 text-white text-[10px] font-bold shadow-sm">
    <i class="fa-solid fa-pen-to-square mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥
</button>

    </div>
    
    <div class="mt-2 pt-1 border-t border-gray-100 text-[9px] text-gray-400 text-right">
        Managing: <span id="popover-username" class="font-bold text-gray-600">...</span>
    </div>
</div>

<div id="popover-overlay" onclick="closeActionMenu()" class="fixed inset-0 z-[90] hidden"></div>
`;

// ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
const oldPopover = document.getElementById('action-popover');
if(oldPopover) oldPopover.remove();
const oldOverlay = document.getElementById('popover-overlay');
if(oldOverlay) oldOverlay.remove();

document.body.insertAdjacentHTML('beforeend', popoverMenuHtml);

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö User ID ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ
let currentMoreActionUserId = null;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
let currentActionUserId = null;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏°‡∏ô‡∏π (Toggle)
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î (Smart Position) ---
window.toggleActionMenu = (event, docId) => {
    event.stopPropagation();
    
    const menu = document.getElementById('action-popover');
    const overlay = document.getElementById('popover-overlay');

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î
    if (currentActionUserId === docId && !menu.classList.contains('hidden')) {
        closeActionMenu();
        return;
    }

    currentActionUserId = docId;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π
    const user = allUsers.find(u => u.docId === docId);
    if(user) {
        document.getElementById('popover-username').innerText = user.username;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç
        const btnInvite = document.getElementById('btn-invite-status');
        const isInviteActive = (user.invite_code_active !== false); 

        if (isInviteActive) {
            btnInvite.innerText = "‚úÖ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ";
            btnInvite.className = "px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-[10px] font-bold shadow-sm transition";
        } else {
            btnInvite.innerText = "‚õî ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç: ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î";
            btnInvite.className = "px-2 py-1 rounded bg-gray-500 hover:bg-gray-600 text-white text-[10px] font-bold shadow-sm transition";
        }
    }
    const btnBan = document.getElementById('btn-ban-user');
        const isBlocked = (user.account_status === 'blocked');

        if (isBlocked) {
            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô‡πÅ‡∏ö‡∏ô‡∏≠‡∏¢‡∏π‡πà -> ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß "‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô"
            btnBan.innerHTML = '<i class="fa-solid fa-unlock mr-1"></i> ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô';
            btnBan.className = "px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-[10px] font-bold shadow-sm transition";
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°/‡πÄ‡∏ó‡∏≤ "‡∏£‡∏∞‡∏á‡∏±‡∏ö"
            btnBan.innerHTML = '<i class="fa-solid fa-ban mr-1"></i> ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
            btnBan.className = "px-2 py-1 rounded bg-gray-600 hover:bg-gray-700 text-white text-[10px] font-bold shadow-sm transition";
        }

    // --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á (Smart Flip) ---
    const btn = event.currentTarget;
    const rect = btn.getBoundingClientRect(); // ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°
    const windowHeight = window.innerHeight;  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠

    // 1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
    menu.classList.remove('hidden');
    const menuHeight = menu.offsetHeight; 
// ... (‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô btnBan) ...

    // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Order Suspend Status)
    const btnOrder = document.getElementById('btn-suspend-order');
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (normal)
    const isOrderSuspended = (user.order_status === 'suspended');

    if (isOrderSuspended) {
        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà -> ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß "‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"
        btnOrder.innerHTML = '<i class="fa-solid fa-play mr-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
        btnOrder.className = "px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-[10px] font-bold shadow-sm transition";
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏° "‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"
        btnOrder.innerHTML = '<i class="fa-solid fa-pause mr-1"></i> ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
        btnOrder.className = "px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-bold shadow-sm transition";
    }
    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏≠‡πÑ‡∏´‡∏°?
    const spaceBelow = windowHeight - rect.bottom;

    if (spaceBelow < menuHeight + 20) {
        // ‚¨ÜÔ∏è ‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠ -> ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô (Flip UP)
        menu.style.top = (rect.top - menuHeight - 8) + 'px';
        menu.style.transformOrigin = "bottom right"; // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏û‡∏∏‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
    } else {
        // ‚¨áÔ∏è ‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏≠ -> ‡πÄ‡∏î‡πâ‡∏á‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (Default)
        menu.style.top = (rect.bottom + 8) + 'px';
        menu.style.transformOrigin = "top right"; // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏û‡∏∏‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤
    }

    // 3. ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 550px (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)
    let leftPos = rect.right - 550 + 20; 
    if(leftPos < 10) leftPos = 10; // ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏à‡∏≠‡∏ã‡πâ‡∏≤‡∏¢
    menu.style.left = leftPos + 'px';

    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Animation
    overlay.classList.remove('hidden');
    requestAnimationFrame(() => {
        menu.classList.remove('scale-95', 'opacity-0');
        menu.classList.add('scale-100', 'opacity-100');
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
window.closeActionMenu = () => {
    const menu = document.getElementById('action-popover');
    const overlay = document.getElementById('popover-overlay');
    
    // Animation ‡∏õ‡∏¥‡∏î
    menu.classList.remove('scale-100', 'opacity-100');
    menu.classList.add('scale-95', 'opacity-0');
    
    currentActionUserId = null;

    // ‡∏£‡∏≠ Animation ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡πà‡∏≠‡∏ô
    setTimeout(() => {
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
    }, 200);
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener: ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Scroll ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà)
window.addEventListener('scroll', () => {
    const menu = document.getElementById('action-popover');
    if (!menu.classList.contains('hidden')) {
        closeActionMenu();
    }
}, true);

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç (Toggle Invite Code)
window.toggleInviteCodeStatus = async (docId) => {
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π Popover ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
    closeActionMenu();

    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentStatus = (user.invite_code_active !== false); // true = ‡πÄ‡∏õ‡∏¥‡∏î, false = ‡∏õ‡∏¥‡∏î
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏≤‡∏°
    const actionWord = currentStatus ? "‡∏õ‡∏¥‡∏î (‡∏£‡∏∞‡∏á‡∏±‡∏ö)" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    const confirmMsg = `‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á?\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "${actionWord}" ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ç‡∏≠‡∏á ${user.username} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n(‡∏´‡∏≤‡∏Å‡∏õ‡∏¥‡∏î ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ)`;

    if (confirm(confirmMsg)) {
        try {
            // ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ (Toggle)
            const newStatus = !currentStatus;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á Database
            await db.collection("users").doc(docId).update({
                invite_code_active: newStatus
            });

            alert(`‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}" ‡πÅ‡∏•‡πâ‡∏ß`);

        } catch (e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        }
    }
}
// --- Modal ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Bank Info) ---
const modalBankInfoHtml = `
<div id="modal-bank-info" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[120] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl modal-scale-in flex flex-col max-h-[90vh]">
        
        <div class="flex justify-between items-center p-4 border-b bg-teal-50 shrink-0">
            <h3 class="font-bold text-teal-800"><i class="fa-solid fa-building-columns text-teal-600"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
            <button onclick="closeModal('modal-bank-info')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="p-6 overflow-y-auto custom-scroll space-y-4 text-sm">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <input type="text" id="bank-holder" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                    <input type="text" id="bank-name" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Bank Code)</label>
                    <input type="text" id="bank-code" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <input type="text" id="bank-acc-no" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none font-bold text-blue-600">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <input type="text" id="bank-phone" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</label>
                    <input type="text" id="bank-branch" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <input type="text" id="bank-address" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">IFSC / CPF</label>
                    <input type="text" id="bank-ifsc" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</label>
                    <input type="text" id="bank-digital" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet No)</label>
                    <input type="text" id="bank-wallet-phone" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet Account)</label>
                    <input type="text" id="bank-wallet-acc" class="w-full border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
                </div>
            </div>

        </div>

        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t shrink-0">
            <button onclick="preSaveBankInfo()" class="bg-teal-600 hover:bg-teal-700 text-white px-8 py-2.5 rounded shadow font-bold transition transform hover:scale-105">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="closeModal('modal-bank-info')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-8 py-2.5 rounded shadow font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<div id="modal-confirm-bank" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[130] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
            <i class="fa-solid fa-file-invoice-dollar text-2xl text-blue-600"></i>
        </div>
        <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
        <p class="text-sm text-gray-500 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <div class="flex gap-3 justify-center">
            <button onclick="executeSaveBankInfo()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button onclick="closeModal('modal-confirm-bank')" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>
`;

document.body.insertAdjacentHTML('beforeend', modalBankInfoHtml);

// --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Load Data) ---
window.openBankInfoModal = (docId) => {
    closeActionMenu(); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    currentActionUserId = docId;

    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á)
    // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô object ‡∏ä‡∏∑‡πà‡∏≠ 'bank_info' ‡πÉ‡∏ô database
    const info = user.bank_info || {};

    document.getElementById('bank-holder').value = info.holder_name || '';
    document.getElementById('bank-name').value = info.bank_name || '';
    document.getElementById('bank-code').value = info.bank_code || '';
    document.getElementById('bank-phone').value = info.bank_phone || '';
    document.getElementById('bank-acc-no').value = info.account_number || '';
    document.getElementById('bank-branch').value = info.branch_code || '';
    document.getElementById('bank-address').value = info.address || '';
    document.getElementById('bank-ifsc').value = info.ifsc_cpf || '';
    document.getElementById('bank-digital').value = info.digital_account || '';
    document.getElementById('bank-wallet-phone').value = info.wallet_phone || '';
    document.getElementById('bank-wallet-acc').value = info.wallet_account || '';

    const modal = document.getElementById('modal-bank-info');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô) ---
window.preSaveBankInfo = () => {
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    const modal = document.getElementById('modal-confirm-bank');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á (Execute Save) ---
window.executeSaveBankInfo = async () => {
    if (!currentActionUserId) return;
    closeModal('modal-confirm-bank'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô Loading
    const saveBtn = document.querySelector('#modal-bank-info button.bg-teal-600');
    const oldText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    saveBtn.disabled = true;

    try {
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Object
        const bankData = {
            holder_name: document.getElementById('bank-holder').value,
            bank_name: document.getElementById('bank-name').value,
            bank_code: document.getElementById('bank-code').value,
            bank_phone: document.getElementById('bank-phone').value,
            account_number: document.getElementById('bank-acc-no').value,
            branch_code: document.getElementById('bank-branch').value,
            address: document.getElementById('bank-address').value,
            ifsc_cpf: document.getElementById('bank-ifsc').value,
            digital_account: document.getElementById('bank-digital').value,
            wallet_phone: document.getElementById('bank-wallet-phone').value,
            wallet_account: document.getElementById('bank-wallet-acc').value
        };

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡πÉ‡∏ô Field 'bank_info' ‡∏Ç‡∏≠‡∏á User
        await db.collection("users").doc(currentActionUserId).update({
            bank_info: bankData
        });

        closeModal('modal-bank-info');
        // alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); // ‡∏õ‡∏¥‡∏î alert ‡πÑ‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß

    } catch (e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    } finally {
        saveBtn.innerHTML = oldText;
        saveBtn.disabled = false;
    }
}
// --- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Overwrite Balance) ---
const modalEditBalanceHtml = `
<div id="modal-edit-balance" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[80] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm modal-scale-in overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b bg-blue-50">
            <h3 class="font-bold text-gray-800"><i class="fa-solid fa-pen-to-square text-blue-600"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Set Balance)</h3>
            <button onclick="closeModal('modal-edit-balance')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 space-y-4">
            
            <div class="flex justify-between text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100">
                <span>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Frozen):</span>
                <span id="edit-bal-frozen" class="font-bold text-red-500">0.00</span>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (Total Balance)</label>
                <div class="relative">
                    <input type="number" id="edit-bal-input" step="0.01" class="w-full border-2 border-blue-100 rounded-lg px-4 py-2 text-lg font-bold text-blue-700 focus:outline-none focus:border-blue-500 bg-white" placeholder="0.00">
                    <span class="absolute right-4 top-3 text-xs text-gray-400">THB</span>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">
                    * ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏ó‡∏±‡∏ö" ‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°)
                </p>
            </div>

        </div>
        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t">
            <button onclick="saveEditBalance()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà</button>
            <button onclick="closeModal('modal-edit-balance')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalEditBalanceHtml);

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î
window.openEditBalanceModal = (docId) => {
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π Popover ‡∏Å‡πà‡∏≠‡∏ô
    closeActionMenu();
    
    currentActionUserId = docId;
    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î Frozen (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ logic ‡∏ô‡∏µ‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà 0 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
    const frozen = frozenMap[user.username] || 0;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Modal
    document.getElementById('edit-bal-frozen').innerText = frozen.toLocaleString();
    
    // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Total Balance) ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
   document.getElementById('edit-bal-input').value = parseFloat(user.balance || 0).toFixed(2);
    const modal = document.getElementById('modal-edit-balance');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (Overwrite)
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (Overwrite) - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        window.saveEditBalance = async () => {
            if (!currentActionUserId) return;

            const newValStr = document.getElementById('edit-bal-input').value;
            let newVal = parseFloat(newValStr);

            if (isNaN(newVal)) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            // ‚úÖ‚úÖ‚úÖ ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            newVal = Number(newVal.toFixed(2));

            if(!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô?\n\n‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏≠‡∏î ${newVal.toLocaleString()} ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`)) {
                return;
            }

            try {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Database ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Set Balance)
                await db.collection("users").doc(currentActionUserId).update({
                    balance: newVal
                });

                closeModal('modal-edit-balance');
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                if(typeof renderTable === 'function') renderTable();

            } catch (e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            }
        }
// --- Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Manage User Full) ---
const modalManageUserHtml = `
<div id="modal-manage-user" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[120] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl modal-scale-in flex flex-col max-h-[90vh]">
        
        <div class="flex justify-between items-center p-4 border-b bg-gray-50 shrink-0">
            <h3 class="font-bold text-gray-800"><i class="fa-solid fa-user-gear text-teal-600"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <button onclick="closeModal('modal-manage-user')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="p-6 overflow-y-auto custom-scroll space-y-4 text-sm">
            
            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô (Agent)</label>
                <input type="text" value="Platform (System)" disabled class="flex-1 border border-gray-200 bg-gray-100 text-gray-500 rounded px-3 py-2 cursor-not-allowed">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600 text-xs">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á <span class="text-red-500">*</span></label>
                <input type="text" id="mng-upline" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)</label>
                <input type="text" id="mng-nameAdmin" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-blue-50/50 text-blue-800 font-bold">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <span class="text-red-500">*</span></label>
                <input type="text" id="mng-username" disabled class="flex-1 border border-gray-200 bg-gray-100 text-gray-500 rounded px-3 py-2 cursor-not-allowed font-bold">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input type="text" id="mng-phone" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>
                <input type="number" id="mng-credit" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none">
            </div>

            <hr class="border-gray-100">

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <input type="number" step="0.01" id="mng-balance" class="flex-1 border border-gray-300 rounded px-3 py-2 font-bold text-blue-600 focus:border-teal-500 focus:outline-none">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á/‡∏ï‡∏¥‡∏î‡∏•‡∏ö</label>
                <div class="flex-1 relative">
                    <input type="text" id="mng-frozen" readonly class="w-full border border-red-200 bg-red-50 text-red-600 font-bold rounded px-3 py-2 cursor-not-allowed">
                    <span class="absolute right-3 top-2 text-[10px] text-red-400">*‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</label>
                <input type="text" id="mng-available" readonly class="flex-1 border border-green-200 bg-green-50 text-green-700 font-bold rounded px-3 py-2 cursor-not-allowed">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="text-red-500">*</span></label>
                <select id="mng-level" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-white"></select>
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</label>
                <select id="mng-status" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-white font-bold">
                    <option value="normal" class="text-green-600">‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)</option>
                    <option value="blocked" class="text-red-600">‚õî ‡∏ö‡∏•‡πá‡∏≠‡∏Å (Blocked)</option>
                </select>
            </div>

            <hr class="border-gray-100">

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600 text-xs">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</label>
                <input type="text" id="mng-password" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-yellow-50 placeholder-gray-400">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600 text-xs">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                <input type="text" id="mng-wd-password" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-yellow-50 placeholder-gray-400">
            </div>

            <div class="flex items-center gap-4">
                <label class="w-40 text-right font-bold text-gray-600 text-xs">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)</label>
              <input type="number" id="mng-tasks" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none bg-white font-bold text-orange-600">
            </div>

            <div class="bg-orange-50 p-3 rounded border border-orange-200">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-dice text-orange-500"></i>
                    <span class="text-xs font-bold text-orange-700">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Random Qty)</span>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1 flex items-center gap-2">
                        <label class="text-xs font-bold text-gray-600">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (Min)</label>
                        <input type="number" id="mng-qty-min" placeholder="1" class="w-full border border-orange-300 rounded px-2 py-1 text-center font-bold text-gray-700 focus:outline-none">
                    </div>
                    <div class="flex-1 flex items-center gap-2">
                        <label class="text-xs font-bold text-gray-600">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Max)</label>
                        <input type="number" id="mng-qty-max" placeholder="300" class="w-full border border-orange-300 rounded px-2 py-1 text-center font-bold text-gray-700 focus:outline-none">
                    </div>
                </div>
                <p class="text-[10px] text-orange-400 mt-1">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
            </div>

            <div class="flex items-start gap-4">
                <label class="w-40 text-right font-bold text-gray-600 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="mng-memo" rows="2" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:border-teal-500 focus:outline-none"></textarea>
            </div>

        </div>

        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t shrink-0">
            <button onclick="saveManageUser()" class="bg-teal-600 hover:bg-teal-700 text-white px-8 py-2.5 rounded shadow font-bold transition transform hover:scale-105">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="closeModal('modal-manage-user')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-8 py-2.5 rounded shadow font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>`;
document.body.insertAdjacentHTML('beforeend', modalManageUserHtml);
// --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Load Data) ---
// --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Load Data) ---
window.openManageUserModal = (docId) => {
    closeActionMenu(); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô
    currentActionUserId = docId;

    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    // 1. ‡πÇ‡∏´‡∏•‡∏î Levels ‡∏•‡∏á Dropdown
    const levelSelect = document.getElementById('mng-level');
    if (levelSelect.options.length === 0) {
        for (const [lvlName, count] of Object.entries(levelMap)) {
            const opt = document.createElement('option');
            opt.value = lvlName;
            opt.innerText = lvlName;
            levelSelect.appendChild(opt);
        }
        if(levelSelect.options.length === 0) {
             ['VIP 1', 'VIP 2', 'VIP 3', 'VIP 4'].forEach(l => {
                 const opt = document.createElement('option'); opt.value = l; opt.innerText = l; levelSelect.appendChild(opt);
             });
        }
    }

    // 2. Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Input Fields
    document.getElementById('mng-upline').value = user.upline || '';
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ nameAdmin ‡∏°‡∏≤‡πÉ‡∏™‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á)
    document.getElementById('mng-nameAdmin').value = user.nameAdmin || ''; 
    
    document.getElementById('mng-username').value = user.username || '';
    document.getElementById('mng-phone').value = user.phone || '';
    document.getElementById('mng-credit').value = user.credit || 100;
    document.getElementById('mng-qty-min').value = user.random_qty_min || 1;
    document.getElementById('mng-qty-max').value = user.random_qty_max || 1;
    document.getElementById('mng-balance').value = parseFloat(user.balance || 0).toFixed(2);
    
    const totalBalance = parseFloat(user.balance || 0);
    const frozenVal = frozenMap[user.username] || 0; 
    const availableVal = totalBalance - frozenVal;

    document.getElementById('mng-frozen').value = frozenVal.toLocaleString(); 
    document.getElementById('mng-available').value = availableVal.toLocaleString();

    document.getElementById('mng-level').value = user.level || 'VIP 1';
    document.getElementById('mng-status').value = (user.account_status === 'blocked') ? 'blocked' : 'normal';

    document.getElementById('mng-password').value = user.password || ''; 
    document.getElementById('mng-wd-password').value = user.withdraw_password || user.password || ''; 
    document.getElementById('mng-tasks').value = user.todayCount || 0;
    document.getElementById('mng-memo').value = user.memo || '';

    const modal = document.getElementById('modal-manage-user');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Save Data) ---
// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ---
window.saveManageUser = () => {
    if (!currentActionUserId) return;
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ß‡∏¢‡πÜ ‡πÅ‡∏ó‡∏ô alert ‡πÄ‡∏î‡∏¥‡∏°
    const modal = document.getElementById('modal-confirm-save');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≠‡∏¢) ---
// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≠‡∏¢) ---
window.executeSaveUser = async () => {
    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    closeModal('modal-confirm-save');

    const saveBtn = document.querySelector('#modal-manage-user button.bg-teal-600');
    const oldText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    saveBtn.disabled = true;

    try {
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        const updateData = {
            upline: document.getElementById('mng-upline').value,
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å nameAdmin ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            nameAdmin: document.getElementById('mng-nameAdmin').value,
            
            // username ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡πá‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)
            // username: document.getElementById('mng-username').value, 

            phone: document.getElementById('mng-phone').value,
            credit: parseInt(document.getElementById('mng-credit').value) || 0,
            balance: parseFloat(document.getElementById('mng-balance').value) || 0,
            frozen_balance: parseFloat(document.getElementById('mng-frozen').value) || 0,
            level: document.getElementById('mng-level').value,
            account_status: document.getElementById('mng-status').value,
            memo: document.getElementById('mng-memo').value,
            todayCount: parseInt(document.getElementById('mng-tasks').value) || 0,
            random_qty_min: parseInt(document.getElementById('mng-qty-min').value) || 1,
            random_qty_max: parseInt(document.getElementById('mng-qty-max').value) || 1,
        };

        const newPass = document.getElementById('mng-password').value;
        if (newPass.trim() !== "") updateData.password = newPass;

        const newWdPass = document.getElementById('mng-wd-password').value;
        if (newWdPass.trim() !== "") updateData.withdraw_password = newWdPass;

        await db.collection("users").doc(currentActionUserId).update(updateData);

        closeModal('modal-manage-user');
        
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showAdminAlert ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ
        if (typeof showAdminAlert === 'function') {
            showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } else {
            alert("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }

    } catch (e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    } finally {
        saveBtn.innerHTML = oldText;
        saveBtn.disabled = false;
    }
}
// --- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Custom Confirm) ---
const modalConfirmSaveHtml = `
<div id="modal-confirm-save" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[130] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-teal-100 mb-4">
            <i class="fa-solid fa-floppy-disk text-2xl text-teal-600"></i>
        </div>

        <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
        <p class="text-sm text-gray-500 mb-6">
            ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
        </p>

        <div class="flex gap-3 justify-center">
            <button onclick="executeSaveUser()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-teal-600 text-base font-medium text-white hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 sm:text-sm transition">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
            <button onclick="closeModal('modal-confirm-save')" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm transition">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalConfirmSaveHtml);

// --- Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏° (Full History) ---
const modalFullHistoryHtml = `
<div id="modal-full-history" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[130] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col modal-scale-in">
        
        <div class="flex justify-between items-center p-4 border-b bg-cyan-600 text-white shrink-0 rounded-t-lg">
            <div>
                <h3 class="font-bold text-lg"><i class="fa-solid fa-list-ul mr-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏ß‡∏° (Transaction History)</h3>
                <p class="text-xs opacity-80 mt-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span id="hist-username" class="font-bold text-yellow-300">...</span> (‡∏£‡∏ß‡∏° ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡πÄ‡∏ï‡∏¥‡∏° / ‡∏ñ‡∏≠‡∏ô)</p>
            </div>
            <button onclick="closeModal('modal-full-history')" class="text-white hover:text-gray-200 bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="bg-gray-50 p-3 border-b flex gap-3 text-xs shrink-0">
            <span class="px-3 py-1 bg-white border rounded shadow-sm font-bold text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="hist-total-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
                <button onclick="changeHistoryPage(-1)" class="px-2 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50" id="btn-prev-top"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="hist-page-info-top" class="font-bold text-gray-600">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
                <button onclick="changeHistoryPage(1)" class="px-2 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50" id="btn-next-top"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll bg-white relative">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-gray-100 shadow-sm z-10">
                    <tr class="text-xs text-gray-600 font-bold uppercase tracking-wider">
                        <th class="p-3 border-b text-center w-16">#</th>
                        <th class="p-3 border-b">‡πÄ‡∏ß‡∏•‡∏≤ (Time)</th>
                        <th class="p-3 border-b text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)</th>
                        <th class="p-3 border-b">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detail / ID)</th>
                        <th class="p-3 border-b text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Amount)</th>
                        <th class="p-3 border-b text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</th>
                    </tr>
                </thead>
                <tbody id="full-history-body" class="text-xs text-gray-700">
                    </tbody>
            </table>
            
            <div id="hist-loading" class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center z-20 hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-cyan-600 mb-2"></i>
                <span class="text-gray-500 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
        </div>

        <div class="p-3 border-t bg-gray-50 shrink-0 flex justify-center items-center gap-4">
            <button onclick="changeHistoryPage(-1)" class="px-4 py-2 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-100 text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed" id="btn-prev">
                <i class="fa-solid fa-chevron-left mr-1"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </button>
            <span id="hist-page-info" class="font-bold text-gray-700 text-sm">‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1</span>
            <button onclick="changeHistoryPage(1)" class="px-4 py-2 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-100 text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed" id="btn-next">
                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalFullHistoryHtml);
// --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏° ---
// --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏ß‡∏° ---
let fullHistoryData = [];
let currentHistoryPage = 1;
const historyPerPage = 10;

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏î‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Frozen/Rejected)
window.openFullUserHistory = async (docId) => {
    closeActionMenu(); 
    currentActionUserId = docId;
    
    const user = allUsers.find(u => u.docId === docId);
    if(!user) return;

    document.getElementById('hist-username').innerText = user.username;
    
    const modal = document.getElementById('modal-full-history');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('hist-loading').classList.remove('hidden');

    try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 3 ‡∏™‡πà‡∏ß‡∏ô (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏¢‡∏≠‡∏î Frozen ‡∏î‡πâ‡∏ß‡∏¢)
        const [ordersSnap, withdrawSnap, rechargeSnap] = await Promise.all([
            db.collection("orders").where("username", "==", user.username).orderBy("timestamp", "desc").limit(100).get(),
            db.collection("withdrawals").where("user_id", "==", docId).orderBy("timestamp", "desc").limit(50).get(),
            db.collection("recharges").where("user_id", "==", docId).orderBy("timestamp", "desc").limit(50).get()
        ]);

        fullHistoryData = [];

        // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏£‡∏ß‡∏° Frozen)
        ordersSnap.forEach(doc => {
            const d = doc.data();
            fullHistoryData.push({
                type: 'order',
                timestamp: d.timestamp,
                amount: d.amount,
                profit: d.commission,
                status: d.status, // completed, pending, frozen
                detail: d.order_id || d.product_name,
                raw: d
            });
        });

        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏ß‡∏° Rejected)
        withdrawSnap.forEach(doc => {
            const d = doc.data();
            fullHistoryData.push({
                type: 'withdraw',
                timestamp: d.timestamp,
                amount: d.amount,
                status: d.status, // approved, pending, rejected
                detail: `${d.bank_name} (${d.account_number})`,
                raw: d
            });
        });

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏ß‡∏° Rejected)
        rechargeSnap.forEach(doc => {
            const d = doc.data();
            fullHistoryData.push({
                type: 'recharge',
                timestamp: d.timestamp,
                amount: d.amount,
                status: d.status,
                detail: d.method || 'Manual Deposit',
                raw: d
            });
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
        fullHistoryData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏ß‡∏°
        document.getElementById('hist-total-count').innerText = fullHistoryData.length;
        
        currentHistoryPage = 1;
        renderHistoryPage();

    } catch (e) {
        console.error(e);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
    } finally {
        document.getElementById('hist-loading').classList.add('hidden');
    }
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
window.renderHistoryPage = () => {
    const tbody = document.getElementById('full-history-body');
    tbody.innerHTML = '';

    const totalPages = Math.ceil(fullHistoryData.length / historyPerPage) || 1;
    const start = (currentHistoryPage - 1) * historyPerPage;
    const end = start + historyPerPage;
    const pageData = fullHistoryData.slice(start, end);

    if (pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</td></tr>`;
    } else {
        pageData.forEach((item, index) => {
            const timeStr = new Date(item.timestamp).toLocaleString('th-TH');
            let typeHtml = '', amountHtml = '', statusHtml = '', rowClass = '';

            // --- üì¶ ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ---
            if (item.type === 'order') {
                typeHtml = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold text-[10px]">üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                
                const comm = item.profit ? `<span class="text-green-600 text-[10px] block">+${parseFloat(item.profit).toLocaleString()} (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°)</span>` : '';
                amountHtml = `<div class="font-bold text-gray-700">‡∏ø${parseFloat(item.amount).toLocaleString()}</div>${comm}`;
                
                if(item.status === 'frozen') {
                    // üî• ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Frozen
                    statusHtml = `<span class="bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200 font-bold text-[10px]"><i class="fa-solid fa-snowflake"></i> ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á</span>`;
                    rowClass = 'bg-red-50'; // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
                } else if(item.status === 'completed') {
                    statusHtml = `<span class="text-green-600 font-bold text-[10px]">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
                } else {
                    statusHtml = `<span class="text-orange-500 text-[10px]">‡∏£‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</span>`;
                }

            // --- üí∏ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ---
            } else if (item.type === 'withdraw') {
                typeHtml = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold text-[10px]">üí∏ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>`;
                amountHtml = `<span class="text-red-600 font-bold">-‡∏ø${parseFloat(item.amount).toLocaleString()}</span>`;
                
                if(item.status === 'rejected' || item.status === 'cancelled') {
                    // ‚ùå ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rejected
                    statusHtml = `<span class="bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200 font-bold text-[10px]"><i class="fa-solid fa-ban"></i> ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>`;
                    rowClass = 'bg-red-50/50';
                } else if(item.status === 'approved') {
                    statusHtml = `<span class="text-green-600 font-bold text-[10px]"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                } else {
                    statusHtml = `<span class="text-orange-500 text-[10px]">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;
                }

            // --- üí∞ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ---
            } else if (item.type === 'recharge') {
                typeHtml = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-[10px]">üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>`;
                amountHtml = `<span class="text-green-600 font-bold">+‡∏ø${parseFloat(item.amount).toLocaleString()}</span>`;
                
                if(item.status === 'rejected') {
                    statusHtml = `<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded border border-gray-200 font-bold text-[10px]"><i class="fa-solid fa-xmark"></i> ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>`;
                } else if(item.status === 'approved') {
                    statusHtml = `<span class="text-green-600 font-bold text-[10px]"><i class="fa-solid fa-check"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
                } else {
                    statusHtml = `<span class="text-orange-500 text-[10px]">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
                }
            }

            tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-100 transition ${rowClass}">
                    <td class="p-3 text-center text-gray-400">${start + index + 1}</td>
                    <td class="p-3 text-[11px] font-mono text-gray-500">${timeStr}</td>
                    <td class="p-3 text-center">${typeHtml}</td>
                    <td class="p-3 text-[11px]">
                        <span class="text-gray-700 block truncate w-32" title="${item.detail}">${item.detail}</span>
                    </td>
                    <td class="p-3 text-right">${amountHtml}</td>
                    <td class="p-3 text-center">${statusHtml}</td>
                </tr>
            `;
        });
    }

    updateHistoryPagination(totalPages);
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
window.changeHistoryPage = (direction) => {
    const totalPages = Math.ceil(fullHistoryData.length / historyPerPage) || 1;
    const newPage = currentHistoryPage + direction;

    if (newPage > 0 && newPage <= totalPages) {
        currentHistoryPage = newPage;
        renderHistoryPage();
    }
}

function updateHistoryPagination(totalPages) {
    const text = `‡∏´‡∏ô‡πâ‡∏≤ ${currentHistoryPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
    document.getElementById('hist-page-info').innerText = text;
    document.getElementById('hist-page-info-top').innerText = text;

    const prevDisabled = currentHistoryPage === 1;
    const nextDisabled = currentHistoryPage === totalPages;

    document.getElementById('btn-prev').disabled = prevDisabled;
    document.getElementById('btn-next').disabled = nextDisabled;
    
    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏î‡πâ‡∏ß‡∏¢
    document.getElementById('btn-prev-top').disabled = prevDisabled;
    document.getElementById('btn-next-top').disabled = nextDisabled;
}

// --- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (Universal Action Confirm) ---
const modalActionConfirmHtml = `
<div id="modal-action-confirm" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[140] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        
        <div id="action-icon-bg" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4 transition-colors">
            <i id="action-icon" class="fa-solid fa-triangle-exclamation text-2xl text-red-600"></i>
        </div>

        <h3 id="action-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        <p id="action-desc" class="text-sm text-gray-500 mb-6">
            ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?
        </p>

        <div class="flex gap-3 justify-center">
            <button onclick="executePendingAction()" id="action-btn-confirm" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none transition">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
            <button onclick="closeModal('modal-action-confirm')" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalActionConfirmHtml);

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
let pendingActionCallback = null;

// --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏•‡∏ö (Ask Delete) ---
// --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏•‡∏ö (Ask Delete) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà ---
window.askDeleteUser = (docId) => {
    closeActionMenu();
    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    setupActionModal({
        title: '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
        desc: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${user.username}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? <br><span class="text-xs text-red-500">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>`,
        icon: 'fa-trash-can',
        colorClass: 'bg-red-600 hover:bg-red-700',
        iconBgClass: 'bg-red-100',
        iconColorClass: 'text-red-600',
        callback: async () => {
            await db.collection("users").doc(docId).delete();
            // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô alert
            showAdminAlert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
    });
}

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ö‡∏ô (Ask Ban/Unban) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà ---
window.askBanUser = (docId) => {
    closeActionMenu();
    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    const isBlocked = (user.account_status === 'blocked');
    
    if (isBlocked) {
        // ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô
        setupActionModal({
            title: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô',
            desc: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ "${user.username}" ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
            icon: 'fa-unlock',
            colorClass: 'bg-green-600 hover:bg-green-700',
            iconBgClass: 'bg-green-100',
            iconColorClass: 'text-green-600',
            callback: async () => {
                await db.collection("users").doc(docId).update({ account_status: 'normal' });
                // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô alert
                showAdminAlert('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        });
    } else {
        // ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ö‡∏ô
        setupActionModal({
            title: '‚õî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
            desc: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á "${user.username}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? <br><span class="text-xs text-gray-500">*‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>`,
            icon: 'fa-ban',
            colorClass: 'bg-orange-600 hover:bg-orange-700',
            iconBgClass: 'bg-orange-100',
            iconColorClass: 'text-orange-600',
            callback: async () => {
                await db.collection("users").doc(docId).update({ account_status: 'blocked' });
                // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô alert
                showAdminAlert('‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        });
    }
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏£‡∏∞‡∏á‡∏±‡∏ö/‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ---
window.askToggleOrderSuspension = (docId) => {
    closeActionMenu();
    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    const isSuspended = (user.order_status === 'suspended');

    if (isSuspended) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ (Unsuspend)
        setupActionModal({
            title: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
            desc: `‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ "${user.username}" ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
            icon: 'fa-play',
            colorClass: 'bg-green-600 hover:bg-green-700',
            iconBgClass: 'bg-green-100',
            iconColorClass: 'text-green-600',
            callback: async () => {
                await db.collection("users").doc(docId).update({ order_status: 'normal' });
                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        });
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏∞‡∏á‡∏±‡∏ö (Suspend)
        setupActionModal({
            title: '‚õî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
            desc: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ "${user.username}" ‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? <br><span class="text-xs text-gray-500">(‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏Å‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</span>`,
            icon: 'fa-pause',
            colorClass: 'bg-orange-500 hover:bg-orange-600',
            iconBgClass: 'bg-orange-100',
            iconColorClass: 'text-orange-500',
            callback: async () => {
                await db.collection("users").doc(docId).update({ order_status: 'suspended' });
                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        });
    }
}
// --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Trigger Error ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡πÜ ‡∏î‡πâ‡∏ß‡∏¢ ---
window.executePendingAction = async () => {
    if (pendingActionCallback) {
        const btn = document.getElementById('action-btn-confirm');
        const oldText = btn.innerText;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        btn.disabled = true;

        try {
            await pendingActionCallback();
            closeModal('modal-action-confirm'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        } catch (e) {
            // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Error Alert ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡πÜ ‡∏™‡∏µ‡πÅ‡∏î‡∏á
            showAdminAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.message, 'error');
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
            pendingActionCallback = null;
        }
    }
}

// --- Helper: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Modal ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå ---
function setupActionModal({ title, desc, icon, colorClass, iconBgClass, iconColorClass, callback }) {
    document.getElementById('action-title').innerText = title;
    document.getElementById('action-desc').innerHTML = desc;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
    const iconEl = document.getElementById('action-icon');
    iconEl.className = `fa-solid ${icon} text-2xl ${iconColorClass}`;
    document.getElementById('action-icon-bg').className = `mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4 transition-colors ${iconBgClass}`;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
    const btn = document.getElementById('action-btn-confirm');
    btn.className = `w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 text-base font-medium text-white focus:outline-none transition ${colorClass}`;

    pendingActionCallback = callback; // ‡∏à‡∏≥‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°

    const modal = document.getElementById('modal-action-confirm');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// --- Trigger: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô Modal ---
window.executePendingAction = async () => {
    if (pendingActionCallback) {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô Loading
        const btn = document.getElementById('action-btn-confirm');
        const oldText = btn.innerText;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        btn.disabled = true;

        try {
            await pendingActionCallback();
            closeModal('modal-action-confirm');
        } catch (e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
            pendingActionCallback = null;
        }
    }
}
// --- Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Success/Error Alert) ---
const modalAdminAlertHtml = `
<div id="modal-admin-alert" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[160] backdrop-blur-sm font-sans" style="z-index: 160;">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        
        <div id="alert-icon-bg" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4 transition-colors">
            <i id="alert-icon" class="fa-solid fa-check text-2xl text-green-600"></i>
        </div>

        <h3 id="alert-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="alert-msg" class="text-sm text-gray-500 mb-6">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>

        <button onclick="closeModal('modal-admin-alert')" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-md px-4 py-2.5 bg-gray-800 text-base font-medium text-white hover:bg-gray-900 focus:outline-none transition">
            ‡∏ï‡∏Å‡∏•‡∏á (OK)
        </button>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalAdminAlertHtml);

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ ---
window.showAdminAlert = (title, msg, type = 'success') => {
    const modal = document.getElementById('modal-admin-alert');
    const iconEl = document.getElementById('alert-icon');
    const bgEl = document.getElementById('alert-icon-bg');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    document.getElementById('alert-title').innerText = title;
    document.getElementById('alert-msg').innerHTML = msg;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (success / error)
    if (type === 'success') {
        iconEl.className = 'fa-solid fa-check text-2xl text-green-600';
        bgEl.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4';
    } else if (type === 'error') {
        iconEl.className = 'fa-solid fa-xmark text-2xl text-red-600';
        bgEl.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4';
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
// --- Modal ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (Admin Memo) ---
const modalMemoHtml = `
<div id="modal-memo" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[130] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm modal-scale-in overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b bg-purple-50">
            <h3 class="font-bold text-purple-800"><i class="fa-solid fa-note-sticky mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (Admin Note)</h3>
            <button onclick="closeModal('modal-memo')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-5 space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-600 mb-2">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</label>
                <textarea id="admin-memo-input" rows="4" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:border-purple-500 focus:outline-none resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°, ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP, ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥"></textarea>
            </div>
            <p class="text-[10px] text-gray-400">* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>
        <div class="bg-gray-50 p-4 flex justify-center gap-3 border-t">
            <button onclick="saveAdminMemo()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="closeModal('modal-memo')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded text-sm font-bold shadow hover:shadow-md transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalMemoHtml);

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Memo
window.openMemoModal = (docId) => {
    closeActionMenu();
    currentActionUserId = docId;
    
    const user = allUsers.find(u => u.docId === docId);
    if (!user) return;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    document.getElementById('admin-memo-input').value = user.admin_memo || '';

    const modal = document.getElementById('modal-memo');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Memo
window.saveAdminMemo = async () => {
    if (!currentActionUserId) return;

    const memoText = document.getElementById('admin-memo-input').value.trim();

    try {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á Database
        await db.collection("users").doc(currentActionUserId).update({
            admin_memo: memoText
        });

        closeModal('modal-memo');
        
        // ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ alert ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
        if(typeof showAdminAlert === 'function') {
            showAdminAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } else {
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

    } catch (e) {
        alert("Error: " + e.message);
    }
}
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏î‡∏¢ "‡∏ô‡∏≥‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° ‡∏°‡∏≤‡∏•‡∏ö ‡∏¢‡∏≠‡∏î‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á" (‡∏´‡∏±‡∏Å‡∏´‡∏ô‡∏µ‡πâ)
       // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ + ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô + ‡∏ö‡∏ß‡∏Å‡∏Å‡∏≥‡πÑ‡∏£ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ admin_members.html ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô)
      // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ + ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô + ‡∏ö‡∏ß‡∏Å‡∏Å‡∏≥‡πÑ‡∏£ + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0
       // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
        async function checkAndUnlockFrozenOrders(userId) {
            try {
                const userRef = db.collection("users").doc(userId);
                const userSnap = await userRef.get();
                if (!userSnap.exists) return;
                
                const userData = userSnap.data();
                const currentBalance = parseFloat(userData.balance || 0); 

                const ordersSnap = await db.collection("orders")
                    .where("username", "==", userData.username)
                    .where("status", "==", "frozen")
                    .get();

                if (ordersSnap.empty) return;

                let totalFrozenNeeded = 0;
                ordersSnap.forEach(doc => { totalFrozenNeeded += parseFloat(doc.data().amount || 0); });

                // --- üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Logic ‡πÉ‡∏´‡∏°‡πà) üî¥ ---
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏¢‡∏π‡πà)
                const availableBalance = currentBalance - totalFrozenNeeded;

                console.log(`Balance: ${currentBalance}, Frozen: ${totalFrozenNeeded}, Available: ${availableBalance}`);

                // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ" ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö "‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î Frozen"
                // ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                if (Number(availableBalance.toFixed(2)) >= Number(totalFrozenNeeded.toFixed(2))) {
                    
                    let batch = db.batch();
                    let profitToAdd = 0; 

                    ordersSnap.forEach(doc => {
                        const orderData = doc.data();
                        const commission = parseFloat(orderData.commission || 0); 
                        profitToAdd += commission;

                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                        batch.update(doc.ref, {
                            status: 'completed',       
                            payment_status: 'paid',    
                            pay_time: new Date().toISOString(),
                            timestamp: new Date().toISOString()
                        });
                    });

                    const finalProfit = Number(profitToAdd.toFixed(2));

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
                    batch.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(finalProfit), 
                        commission: firebase.firestore.FieldValue.increment(finalProfit),
                        "trap_config.is_triggered": true, 
                        todayCount: 0 // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0
                    });

                    await batch.commit();

                    const netBalance = Number((currentBalance + finalProfit).toFixed(2));
                    
                    alert(`üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà)\n\n- ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${netBalance.toLocaleString()}\n- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0`);
                    
                    if(typeof renderTable === 'function') renderTable();
                    if(typeof renderHistoryTable === 'function') renderHistoryTable(userId);
                } else {
                    console.log("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°)");
                }
            } catch (e) {
                console.error("Auto Unlock Error:", e);
            }
        }
    </script>
    
</body>
</html>