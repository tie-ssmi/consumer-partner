<!DOCTYPE html>
<html lang="th">
<head>
    <script>
    // Security Check
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        window.location.href = '../admin_login/index.html';
    }
    </script>
    <meta charset="UTF-8">
    <title>Admin - Product List</title>
    <link rel="stylesheet" href="js/admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style> 
        /* ปรับแต่ง Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        th, td { 
            padding: 8px 8px; 
            font-size: 12px; 
            vertical-align: middle; 
            white-space: nowrap; 
        }
        
        thead th { position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .sys-menu-header { color: #4b646f; background: #1a2226; padding: 10px 25px 10px 15px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .sys-menu-item { display: block; padding: 12px 15px; color: #b8c7ce; border-bottom: 1px solid #222d32; transition: all 0.3s; font-size: 13px; cursor: pointer; text-decoration: none; }
        .sys-menu-item:hover { background-color: #1e282c; color: #fff; }
        .sys-menu-item.active { background-color: #1e282c; color: #fff; border-left: 3px solid #00a65a; }
        .sys-menu-item i { width: 20px; margin-right: 10px; text-align: center; }

        /* Style สำหรับโหมดแก้ไข */
        .edit-input { border: 1px solid #ddd; padding: 4px; border-radius: 4px; width: 100%; font-size: 12px; }
        .edit-input:focus { border-color: #3b82f6; outline: none; background: #eff6ff; }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen overflow-hidden flex flex-col"> 
    <script src="js/admin_ui.js"></script>
    <script src="js/firebase_setup.js"></script> 

    <script>
        renderAdminUI('trading', 'plist');

        setTimeout(() => {
            const sidebarContainer = document.querySelector('aside') || document.getElementById('sidebar-menu'); 
            if (sidebarContainer) {
                sidebarContainer.innerHTML = `
                    <div class="h-full bg-[#222d32] overflow-y-auto custom-scroll pt-2">
                        <div class="sys-menu-header">การจัดการธุรกรรม</div>
                        <a href="admin_orders.html" class="sys-menu-item"><i class="fa-solid fa-cart-shopping"></i> รายการสั่งซื้อ</a>
                        <a href="admin_recharge.html" class="sys-menu-item"><i class="fa-solid fa-money-bill-transfer"></i> การจัดการการเติมเงิน</a>
                        <a href="#" class="sys-menu-item"><i class="fa-solid fa-hand-holding-dollar"></i> การจัดการการถอนเงิน</a>
                        <a href="#" class="sys-menu-item"><i class="fa-solid fa-gauge-high"></i> การควบคุมธุรกรรม</a>
                        <div class="sys-menu-header">การจัดการผลิตภัณฑ์</div>
                        <a href="admin_product_list.html" class="sys-menu-item active"><i class="fa-solid fa-box-open"></i> รายการสินค้า</a>
                        <a href="#" class="sys-menu-item"><i class="fa-solid fa-tags"></i> หมวดหมู่สินค้า</a>
                    </div>
                `;
            }
        }, 100);

        document.getElementById('main-content').innerHTML = `
            <div class="flex flex-col h-full max-h-screen pb-4"> 
                <div class="px-4 py-3 flex justify-between items-center bg-white border-b mb-3 shadow-sm shrink-0 gap-2">
                    <span class="text-gray-600 font-bold text-lg">รายการสินค้า</span>
                    
                    <div class="flex gap-2">
                        <button onclick="openImportModal()" class="bg-indigo-500 text-white px-3 py-1.5 rounded text-xs hover:bg-indigo-600 font-bold shadow transition flex items-center">
                            <i class="fa-solid fa-file-import mr-1"></i> นำเข้าข้อมูล (Import)
                        </button>

                        <button id="btnToggleEdit" onclick="toggleEditMode()" class="bg-yellow-500 text-white px-3 py-1.5 rounded text-xs hover:bg-yellow-600 font-bold shadow transition flex items-center">
                            <i class="fa-solid fa-pen-to-square mr-1"></i> แก้ไขด่วน (Quick Edit)
                        </button>
                        
                        <button onclick="openModal('add')" class="bg-[#00a65a] text-white px-3 py-1.5 rounded text-xs hover:bg-[#008d4c] font-bold shadow transition flex items-center">
                            <i class="fa-solid fa-plus mr-1"></i> เพิ่มสินค้า
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-2 rounded-lg shadow-sm border border-gray-200 mb-2 mx-4 flex justify-between items-center shrink-0">
                    <div class="relative w-64">
                        <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="ค้นหาชื่อสินค้า..." class="border pl-8 pr-2 py-1.5 text-xs rounded w-full focus:outline-none focus:border-blue-400 bg-gray-50">
                        <i class="fa-solid fa-search absolute left-2.5 top-2 text-gray-400 text-xs"></i>
                    </div>

                    <div id="bulkActionPanel" class="hidden flex items-center gap-2 animate-pulse">
                        <span class="text-xs text-orange-600 font-bold"><i class="fa-solid fa-circle-exclamation"></i> กำลังอยู่ในโหมดแก้ไข</span>
                        <button onclick="saveBulkChanges()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 font-bold shadow transition">
                            <i class="fa-solid fa-save mr-1"></i> บันทึกทั้งหมด
                        </button>
                        <button onclick="toggleEditMode()" class="bg-gray-400 text-white px-3 py-1.5 rounded text-xs hover:bg-gray-500 font-bold shadow transition">
                            ยกเลิก
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden mx-4 bg-white rounded-lg shadow-sm border border-gray-200 relative">
                    <div class="absolute inset-0 overflow-auto custom-scroll"> 
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 border-b text-gray-600 uppercase text-[11px]">
                                <tr>
                                    <th class="w-20 text-center bg-gray-50">รูป / Link</th> 
                                    <th class="w-16 text-center bg-gray-50">ID</th>
                                    <th class="w-28 bg-gray-50">หมวดหมู่</th>
                                    <th class="min-w-[200px] bg-gray-50">ชื่อสินค้า</th>
                                    <th class="text-right w-24 bg-gray-50">ราคา</th>
                                    <th class="text-center w-16 bg-gray-50">สต็อก</th>
                                    <th class="text-center w-24 bg-gray-50">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="product-body" class="text-gray-700 divide-y divide-gray-100 text-sm">
                                <tr><td colspan="7" class="text-center p-8 text-gray-400">กำลังโหลดข้อมูล...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-between items-center px-4 py-2 mt-2 mx-4 bg-white rounded-lg shadow-sm border border-gray-200 shrink-0 h-12">
                    <span class="text-xs text-gray-500 font-bold" id="pageInfo">...</span>
                    <div class="flex gap-2">
                        <button onclick="changePage(-1)" id="btnPrev" class="px-3 py-1 bg-white border border-gray-300 rounded text-xs hover:bg-gray-50 disabled:opacity-50 transition font-bold text-gray-600 flex items-center">
                            <i class="fa-solid fa-chevron-left mr-1"></i> ก่อนหน้า
                        </button>
                        <button onclick="changePage(1)" id="btnNext" class="px-3 py-1 bg-white border border-gray-300 rounded text-xs hover:bg-gray-50 disabled:opacity-50 transition font-bold text-gray-600 flex items-center">
                            ถัดไป <i class="fa-solid fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
                <div class="bg-white rounded-lg shadow-2xl w-96 p-6 transform transition-all scale-100">
                    <h2 id="modalTitle" class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">เพิ่มสินค้า</h2>
                    <input type="hidden" id="editDocId"> 
                    
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="block text-xs text-gray-500 mb-1 font-bold">รหัส (Auto)</label>
                                <input type="text" id="inpId" class="w-full border p-2 rounded text-xs bg-gray-100" disabled>
                            </div>
                            <div class="w-2/3">
                                <label class="block text-xs text-gray-500 mb-1 font-bold">หมวดหมู่</label>
                                <select id="inpCategory" class="w-full border p-2 rounded text-xs bg-white focus:outline-none focus:border-blue-500"></select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-500 mb-1 font-bold">ชื่อสินค้า</label>
                            <textarea id="inpName" class="w-full border p-2 rounded text-xs focus:outline-none focus:border-blue-500" rows="2"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-500 mb-1 font-bold">ลิงก์รูปภาพ (Image URL)</label>
                            <input type="text" id="inpImage" class="w-full border p-2 rounded text-xs focus:outline-none focus:border-blue-500" placeholder="https://example.com/pic.jpg">
                        </div>

                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="block text-xs text-gray-500 mb-1 font-bold">ราคา (บาท)</label>
                                <input type="number" id="inpPrice" class="w-full border p-2 rounded text-xs focus:outline-none focus:border-blue-500 text-right font-bold" placeholder="0.00">
                            </div>
                            <div class="w-1/3">
                                <label class="block text-xs text-gray-500 mb-1 font-bold">สต็อก</label>
                                <input type="number" id="inpQty" class="w-full border p-2 rounded text-xs focus:outline-none focus:border-blue-500 text-center font-bold text-blue-600" placeholder="0">
                            </div>
                            <div class="w-1/3">
                                <label class="block text-xs text-gray-500 mb-1 font-bold">หน่วย</label>
                                <input type="text" id="inpUnit" class="w-full border p-2 rounded text-xs focus:outline-none focus:border-blue-500 text-center" placeholder="ชิ้น">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6 pt-2 border-t">
                        <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded text-xs font-bold hover:bg-gray-400">ยกเลิก</button>
                        <button onclick="saveData()" class="px-4 py-2 bg-[#00a65a] text-white rounded text-xs font-bold shadow hover:bg-[#008d4c]">บันทึก</button>
                    </div>
                </div>
            </div>

            <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
                <div class="bg-white rounded-lg shadow-2xl w-[500px] p-6">
                    <h2 class="text-lg font-bold mb-2 text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-file-import text-indigo-500"></i> นำเข้าข้อมูล (Import Data)
                    </h2>
                    <p class="text-xs text-gray-500 mb-3">วางโค้ด JSON ที่ได้จากสคริปต์ดูดข้อมูล Lazada/Shopee ลงในช่องนี้</p>
                    
                    <textarea id="inpImportJson" class="w-full h-48 border p-3 rounded text-xs font-mono bg-gray-50 focus:outline-none focus:border-indigo-500" placeholder='[ {"name": "สินค้า...", "price": 100, ...} ]'></textarea>
                    
                    <div class="flex justify-end gap-2 mt-4 pt-2 border-t">
                        <button onclick="document.getElementById('importModal').classList.add('hidden'); document.getElementById('importModal').classList.remove('flex');" class="px-4 py-2 bg-gray-300 text-gray-700 rounded text-xs font-bold hover:bg-gray-400">ยกเลิก</button>
                        <button onclick="processImport()" class="px-4 py-2 bg-indigo-500 text-white rounded text-xs font-bold shadow hover:bg-indigo-600">
                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i> นำเข้าข้อมูล
                        </button>
                    </div>
                </div>
            </div>
        `;

        // --- JavaScript Logic ---
        let allProducts = [];
        let filteredProducts = [];
        let categoryList = []; 
        let currentPage = 1;
        const itemsPerPage = 10; 
        
        let isEditMode = false;

        function fetchProducts() {
            if (!window.db) return setTimeout(fetchProducts, 500);
            fetchCategories();

            db.collection("products").get().then((snap) => {
                allProducts = [];
                snap.forEach(d => allProducts.push({docId: d.id, ...d.data()}));
                allProducts.sort((a,b) => a.id - b.id);
                filteredProducts = [...allProducts];
                renderTable();
            });
        }

        function handleSearch() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(search));
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('product-body');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-400 font-bold bg-gray-50">ไม่พบข้อมูลสินค้า</td></tr>';
                updatePaginationControls();
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredProducts.slice(startIndex, endIndex);

            tbody.innerHTML = '';
            
            pageData.forEach(p => {
                const pStr = JSON.stringify(p).replace(/"/g, '&quot;');
                let imgDisplay = p.image && p.image.startsWith('http') 
                    ? `<img src="${p.image}" class="w-8 h-8 rounded object-cover border bg-white cursor-pointer hover:scale-150 transition z-10 relative">` 
                    : '<div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-gray-400"><i class="fa-solid fa-image"></i></div>';

                let rowContent = '';

                // ✅ เช็คว่าอยู่ในโหมดแก้ไขหรือไม่
                if (isEditMode) {
                    rowContent = `
                        <td class="text-center py-2 flex flex-col gap-1 items-center">
                            ${imgDisplay}
                            <input type="text" value="${p.image || ''}" class="edit-input inp-img-${p.docId} text-[9px] w-full" placeholder="Link รูปภาพ">
                        </td>
                        <td class="text-center text-gray-500 text-[10px] align-top pt-3">${p.id}</td>
                        <td class="align-top pt-2">
                            <input type="text" value="${p.category || ''}" class="edit-input inp-cat-${p.docId}" placeholder="หมวดหมู่">
                        </td>
                        <td class="align-top pt-2">
                            <input type="text" value="${p.name}" class="edit-input inp-name-${p.docId} font-bold text-blue-700">
                        </td>
                        <td class="align-top pt-2">
                            <input type="number" value="${p.price}" class="edit-input inp-price-${p.docId} text-right font-bold text-green-600">
                        </td>
                        <td class="align-top pt-2">
                            <input type="number" value="${p.quantity || 1}" class="edit-input inp-qty-${p.docId} text-center font-bold">
                        </td>
                        <td class="text-center text-xs text-gray-400 align-top pt-4">
                            <i class="fa-solid fa-pen text-orange-400 animate-pulse"></i> Editing
                        </td>
                    `;
                } else {
                    rowContent = `
                        <td class="text-center py-2">${imgDisplay}</td>
                        <td class="text-center text-gray-500 font-mono text-[10px]">${p.id}</td>
                        <td><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] border border-gray-200 font-bold whitespace-nowrap">${p.category}</span></td>
                        <td class="max-w-[250px] text-xs font-bold text-gray-700 truncate cursor-help" title="${p.name}">
                            ${p.name.length > 60 ? p.name.substring(0, 60) + '...' : p.name}
                        </td>
                        <td class="text-right font-bold text-gray-600">${Number(p.price).toLocaleString()}</td>
                        <td class="text-center"><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100 font-bold">${(p.quantity||0).toLocaleString()}</span></td>
                        <td class="text-center flex gap-1 justify-center py-2">
                            <button onclick="openModal('edit', ${pStr})" class="bg-orange-400 text-white w-7 h-7 rounded flex items-center justify-center hover:bg-orange-500 shadow-sm transition"><i class="fa-solid fa-pen text-[10px]"></i></button>
                            <button onclick="deleteItem('${p.docId}')" class="bg-red-500 text-white w-7 h-7 rounded flex items-center justify-center hover:bg-red-600 shadow-sm transition"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </td>
                    `;
                }

                tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-blue-50 border-b transition group">${rowContent}</tr>`);
            });

            updatePaginationControls();
        }

        // --- Bulk Edit Functions ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btnToggleEdit');
            const panel = document.getElementById('bulkActionPanel');
            
            if (isEditMode) {
                btn.innerHTML = '<i class="fa-solid fa-times mr-1"></i> ปิดโหมดแก้ไข';
                btn.className = "bg-gray-500 text-white px-3 py-1.5 rounded text-xs hover:bg-gray-600 font-bold shadow transition flex items-center";
                panel.classList.remove('hidden');
                panel.classList.add('flex');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pen-to-square mr-1"></i> แก้ไขด่วน (Quick Edit)';
                btn.className = "bg-yellow-500 text-white px-3 py-1.5 rounded text-xs hover:bg-yellow-600 font-bold shadow transition flex items-center";
                panel.classList.add('hidden');
                panel.classList.remove('flex');
            }
            renderTable();
        }

        async function saveBulkChanges() {
            if(!confirm("ยืนยันการบันทึกการแก้ไขทั้งหมดในหน้านี้?")) return;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredProducts.slice(startIndex, endIndex);
            
            const batchPromises = [];

            pageData.forEach(p => {
                const newName = document.querySelector(`.inp-name-${p.docId}`)?.value;
                const newPrice = document.querySelector(`.inp-price-${p.docId}`)?.value;
                const newQty = document.querySelector(`.inp-qty-${p.docId}`)?.value;
                const newCat = document.querySelector(`.inp-cat-${p.docId}`)?.value;
                const newImg = document.querySelector(`.inp-img-${p.docId}`)?.value; // ✅ รับค่าลิงก์รูปภาพใหม่

                if (newName && newPrice && newQty) {
                    batchPromises.push(
                        db.collection("products").doc(p.docId).update({
                            name: newName,
                            price: Number(newPrice),
                            quantity: Number(newQty),
                            category: newCat,
                            image: newImg // ✅ บันทึกรูปภาพลง Database
                        })
                    );
                }
            });

            try {
                await Promise.all(batchPromises);
                alert("บันทึกข้อมูลสำเร็จ!");
                toggleEditMode(); 
                fetchProducts();  
            } catch (e) {
                alert("เกิดข้อผิดพลาด: " + e.message);
            }
        }

        // --- Import Functions ---
        function openImportModal() {
            const m = document.getElementById('importModal');
            m.classList.remove('hidden'); m.classList.add('flex');
            document.getElementById('inpImportJson').value = '';
        }

        async function processImport() {
            const jsonStr = document.getElementById('inpImportJson').value;
            if (!jsonStr.trim()) return alert("กรุณาวางข้อมูล JSON ก่อนครับ");

            try {
                let data = JSON.parse(jsonStr);
                if (!Array.isArray(data)) data = [data];

                if (!confirm(`ยืนยันการนำเข้าสินค้าจำนวน ${data.length} รายการ?`)) return;

                let successCount = 0;
                let maxId = allProducts.length > 0 ? Math.max(...allProducts.map(p => p.id)) : 0;

                for (const item of data) {
                    maxId++;
                    const newId = maxId;
                    const prodIdStr = String(newId).padStart(4, '0');
                    
                    await db.collection("products").add({
                        id: newId,
                        product_id: prodIdStr,
                        name: item.name || "สินค้านำเข้า",
                        price: Number(item.price || 0),
                        image: item.image || "",
                        category: item.category || "General",
                        quantity: Number(item.quantity || item.stock || 1),
                        stock: Number(item.stock || 10),
                        sold: Number(item.sold || 0),
                        status: "active",
                        unit: item.unit || "ชิ้น",
                        time: new Date().toLocaleDateString('th-TH') + " (Import)"
                    });
                    successCount++;
                }

                alert(`นำเข้าสำเร็จ ${successCount} รายการ!`);
                document.getElementById('importModal').classList.add('hidden');
                document.getElementById('importModal').classList.remove('flex');
                fetchProducts();

            } catch (e) {
                alert("รูปแบบ JSON ไม่ถูกต้อง หรือเกิดข้อผิดพลาด: " + e.message);
            }
        }

        // --- Pagination & Modal Functions ---
        function updatePaginationControls() {
            const totalItems = filteredProducts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = totalItems === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            document.getElementById('pageInfo').innerText = `แสดง ${startItem}-${endItem} จาก ${totalItems} รายการ (หน้า ${currentPage}/${totalPages || 1})`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages || totalPages === 0;
        }

        window.changePage = (direction) => {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const newPage = currentPage + direction;
            if (newPage > 0 && newPage <= totalPages) { currentPage = newPage; renderTable(); }
        }

        function fetchCategories() {
            db.collection("categories").get().then((snap) => {
                categoryList = [];
                snap.forEach(doc => { categoryList.push(doc.data().name); });
                categoryList.sort();
            });
        }

        window.openModal = async (mode, data = null) => {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modalTitle');
            const catSelect = document.getElementById('inpCategory');

            catSelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
            if (categoryList.length === 0) await fetchCategories();
            categoryList.forEach(catName => {
                const option = document.createElement('option');
                option.value = catName; option.innerText = catName;
                catSelect.appendChild(option);
            });

            document.getElementById('editDocId').value = '';
            document.getElementById('inpName').value = '';
            document.getElementById('inpPrice').value = '';
            document.getElementById('inpQty').value = '1'; 
            document.getElementById('inpUnit').value = '';
            document.getElementById('inpImage').value = '';

            if (mode === 'add') {
                title.innerText = 'เพิ่มสินค้าใหม่';
                const maxId = allProducts.length > 0 ? Math.max(...allProducts.map(p => p.id)) : 0;
                document.getElementById('inpId').value = maxId + 1;
                catSelect.value = "";
            } else {
                title.innerText = 'แก้ไขสินค้า';
                document.getElementById('editDocId').value = data.docId;
                document.getElementById('inpId').value = data.id;
                document.getElementById('inpName').value = data.name;
                document.getElementById('inpPrice').value = data.price;
                document.getElementById('inpQty').value = data.quantity || 0;
                document.getElementById('inpUnit').value = data.unit;
                document.getElementById('inpImage').value = data.image || '';
                catSelect.value = data.category;
            }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        window.closeModal = () => { 
            document.getElementById('productModal').classList.add('hidden'); 
            document.getElementById('productModal').classList.remove('flex');
        }

        let isSaving = false;
        window.saveData = async () => {
            if (isSaving) return;
            const docId = document.getElementById('editDocId').value;
            const category = document.getElementById('inpCategory').value;
            const name = document.getElementById('inpName').value.trim();
            const image = document.getElementById('inpImage').value; 
            const price = Number(document.getElementById('inpPrice').value);
            const quantity = Number(document.getElementById('inpQty').value);
            const unit = document.getElementById('inpUnit').value;

            if (category === "") return alert("กรุณาเลือกหมวดหมู่สินค้า!");
            if (name === "") return alert("กรุณากรอกชื่อสินค้า!");

            isSaving = true;
            const saveBtn = document.querySelector('#productModal button.bg-\\[\\#00a65a\\]');
            const oldText = saveBtn ? saveBtn.innerText : 'บันทึก';
            if (saveBtn) { saveBtn.innerText = 'กำลังบันทึก...'; saveBtn.disabled = true; saveBtn.classList.add('opacity-50'); }

            try {
                const now = new Date();
                const timeStr = now.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' }) + ', ' + now.toLocaleTimeString('th-TH');
                const dataObj = { id: Number(document.getElementById('inpId').value), category, name, image, price, quantity, unit, time: timeStr };

                if (docId) { await db.collection("products").doc(docId).update(dataObj); } 
                else { await db.collection("products").add(dataObj); }

                closeModal(); fetchProducts(); alert("บันทึกข้อมูลเรียบร้อย!");
            } catch (e) { alert("เกิดข้อผิดพลาด: " + e.message); } 
            finally { isSaving = false; if (saveBtn) { saveBtn.innerText = oldText; saveBtn.disabled = false; saveBtn.classList.remove('opacity-50'); } }
        }

        window.deleteItem = async (docId) => {
            if (confirm("ยืนยันการลบสินค้านี้?")) {
                await db.collection("products").doc(docId).delete();
                fetchProducts();
            }
        }
        setTimeout(fetchProducts, 500);
    </script>
</body>
</html>