<!DOCTYPE html>
<html lang="th">
<head>
<script>
    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Security Check) ---
    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤ 'admin_logged_in' ‡πÄ‡∏õ‡πá‡∏ô 'true'
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        // ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡∏≠‡∏¢‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ 1 ‡∏Ç‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ admin_login)
        window.location.href = '../admin_login/index.html';
    }
</script>

    <meta charset="UTF-8">
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="js/admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style> 
        .table-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; } 
        th, td { padding: 14px 10px; font-size: 11px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        tr:hover { background-color: #f8fafc; transition: 0.2s; }
        .badge-pending { background-color: #fff7ed; color: #c2410c; }
        .badge-approved { background-color: #f0fdf4; color: #15803d; }
        .badge-rejected { background-color: #fef2f2; color: #b91c1c; }
        .btn-action { padding: 5px 10px; border-radius: 6px; color: white; font-size: 10px; cursor: pointer; }
        .btn-approve { background-color: #10b981; } .btn-reject { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <script src="js/admin_ui.js"></script>
    <script src="js/firebase_setup.js"></script> 

    <script>
        renderAdminUI('finance', 'recharge'); 

        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-5 shadow-sm border-b flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Recharge)</h2>
                <button onclick="fetchRecharges()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded text-xs font-bold hover:bg-indigo-100"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 mx-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <select id="filter-status" onchange="renderTable()" class="border px-3 py-2 text-xs rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option><option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option><option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option></select>
                    <input type="text" id="search-input" onkeyup="renderTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border pl-9 pr-3 py-2 text-xs rounded-lg w-full">
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mx-4 overflow-hidden">
                <div class="table-wrapper custom-scroll">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="pl-6">Order ID</th>
                                <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                <th class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="text-center pr-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="recharge-body"></tbody>
                    </table>
                </div>
            </div>
        `;

        let allRecharges = [];
        function formatDateTime(isoString) { if(!isoString) return "-"; const d = new Date(isoString); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

        function fetchRecharges() {
            if (!window.db) return setTimeout(fetchRecharges, 1000);
            db.collection("recharges").onSnapshot((snapshot) => {
                allRecharges = [];
                snapshot.forEach(doc => allRecharges.push({ docId: doc.id, ...doc.data() }));
                renderTable();
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recharge-body');
            const statusFilter = document.getElementById('filter-status').value;
            const searchText = document.getElementById('search-input').value.toLowerCase();
            allRecharges.sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            let html = '';
            allRecharges.forEach(r => {
                if (statusFilter !== 'all' && r.status !== statusFilter) return;
                if (searchText && !r.username.toLowerCase().includes(searchText)) return;
                const amount = parseFloat(r.amount);
                let statusBadge, actions;
                if (r.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending p-1 rounded text-xs">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô confirmProcessRecharge ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á parameter ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏≠‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á
const displayId = r.order_id || r.docId;

actions = `<button onclick="confirmProcessRecharge('${r.docId}', '${displayId}', 'approve', ${amount}, '${r.user_id}', '${r.username}')" class="btn-action btn-approve mr-1 shadow hover:bg-green-600 transition">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
           <button onclick="confirmProcessRecharge('${r.docId}', '${displayId}', 'reject', ${amount}, '${r.user_id}', '${r.username}')" class="btn-action btn-reject shadow hover:bg-red-600 transition">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>`;
                } else if (r.status === 'approved') { statusBadge = '<span class="badge badge-approved p-1 rounded text-xs">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>'; actions = '-'; }
                else { statusBadge = '<span class="badge badge-rejected p-1 rounded text-xs">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>'; actions = '-'; }
                html += `<tr class="border-b hover:bg-gray-50">
<td class="pl-6 font-mono text-xs text-gray-500">${r.order_id || r.docId}</td><td><div class="font-bold text-gray-700 text-sm">${r.username}</div><div class="text-[10px] text-gray-400">${r.phone||'-'}</div></td><td><span class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-[10px] font-bold">${r.level||'Top-up'}</span></td><td class="text-right font-bold text-gray-800 text-sm">‡∏ø${amount.toLocaleString()}</td><td class="text-center text-[10px]">${r.type||'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô'}</td><td class="text-xs text-gray-500">${formatDateTime(r.timestamp)}</td><td class="text-center">${statusBadge}</td><td class="text-center pr-6 flex justify-center py-3">${actions}</td></tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="8" class="text-center p-12 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        }

        async function processRecharge(docId, action, amount = 0, userId = null, username = null) {
            let confirmMsg = action === 'approve' ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î ‡∏ø${amount}?` : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò?";
            if(confirm(confirmMsg)) {
                try {
                    let targetUserRef = null;
                    if (action === 'approve') {
                        let docSnap = await db.collection("users").doc(userId).get();
                        if (docSnap.exists) targetUserRef = docSnap.ref;
                        else {
                            let querySnap = await db.collection("users").where("id", "==", userId).limit(1).get();
                            if (!querySnap.empty) targetUserRef = querySnap.docs[0].ref;
                            else if (username) {
                                let userQuery = await db.collection("users").where("username", "==", username).limit(1).get();
                                if (!userQuery.empty) targetUserRef = userQuery.docs[0].ref;
                            }
                        }
                        if (!targetUserRef) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö User ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"); return; }
                    }
                    const status = action === 'approve' ? 'approved' : 'rejected';
                    await db.collection("recharges").doc(docId).update({ status: status });
                    if (action === 'approve' && targetUserRef) {
                        await db.runTransaction(async (transaction) => {
                            const userDoc = await transaction.get(targetUserRef);
                            const currentBal = parseFloat(userDoc.data().balance) || 0;
                            transaction.update(targetUserRef, { balance: currentBal + parseFloat(amount) });
                        });
                        await db.collection("notifications").add({ user_id: targetUserRef.id, title: 'üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', message: `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount.toLocaleString()} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, read: false, timestamp: new Date().toISOString() });
                    }
                    alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch(e) { alert("Error: " + e.message); }
            }
        }
        fetchRecharges();

       // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ---
       // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ---
        let pendingRecharge = null;

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏£‡∏±‡∏ö displayId ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå)
        function confirmProcessRecharge(docId, displayId, action, amount = 0, userId = null, username = null) {
            pendingRecharge = { docId, displayId, action, amount, userId, username };

            const modal = document.getElementById('modal-recharge-confirm');
            const iconBg = document.getElementById('rc-icon-bg');
            const icon = document.getElementById('rc-icon');
            const btn = document.getElementById('rc-btn-confirm');
            const title = document.getElementById('rc-title');
            const desc = document.getElementById('rc-desc');

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ
            btn.disabled = false;
            btn.innerHTML = action === 'approve' ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve)" : "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (Reject)";

            if (action === 'approve') {
                // ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                iconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4";
                icon.className = "fa-solid fa-check text-2xl text-green-600";
                title.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô";
                
                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Order ID ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤
                desc.innerHTML = `
                    <div class="mb-2 text-xs text-gray-400">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Order ID)</div>
                    <div class="mb-4 font-mono font-bold text-gray-800 bg-gray-100 rounded py-1 px-2 select-all">${displayId}</div>
                    ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î <span class="font-bold text-green-600 text-lg">‡∏ø${amount.toLocaleString()}</span><br>
                    ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                `;
                
                btn.className = "w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-green-600 text-base font-medium text-white hover:bg-green-700 transition";
            } else {
                // ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á
                iconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4";
                icon.className = "fa-solid fa-xmark text-2xl text-red-600";
                title.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò";
                
                desc.innerHTML = `
                    <div class="mb-2 text-xs text-gray-400">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Order ID)</div>
                    <div class="mb-4 font-mono font-bold text-gray-800 bg-gray-100 rounded py-1 px-2 select-all">${displayId}</div>
                    ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á "${username}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
                    <span class="text-xs text-red-500">*‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
                `;
                
                btn.className = "w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-red-600 text-base font-medium text-white hover:bg-red-700 transition";
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
        async function executeRechargeAction() {
            if (!pendingRecharge) return;

            const { docId, action, amount, userId, username } = pendingRecharge;
            const btn = document.getElementById('rc-btn-confirm');
            
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            btn.disabled = true;

            try {
                let targetUserRef = null;

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ User ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô
                if (action === 'approve') {
                    let docSnap = await db.collection("users").doc(userId).get();
                    if (docSnap.exists) {
                        targetUserRef = docSnap.ref;
                    } else {
                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ userId ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
                        let querySnap = await db.collection("users").where("id", "==", userId).limit(1).get();
                        if (!querySnap.empty) targetUserRef = querySnap.docs[0].ref;
                        else if (username) {
                            let userQuery = await db.collection("users").where("username", "==", username).limit(1).get();
                            if (!userQuery.empty) targetUserRef = userQuery.docs[0].ref;
                        }
                    }
                    if (!targetUserRef) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Not Found)");
                }

                const status = action === 'approve' ? 'approved' : 'rejected';
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                await db.collection("recharges").doc(docId).update({ status: status });

                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -> ‡∏ö‡∏ß‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
                if (action === 'approve' && targetUserRef) {
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(targetUserRef);
                        const currentBal = parseFloat(userDoc.data().balance) || 0;
                        transaction.update(targetUserRef, { balance: currentBal + parseFloat(amount) });
                    });
                    
                    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô User
                    await db.collection("notifications").add({ 
                        user_id: targetUserRef.id, 
                        title: 'üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                        message: `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount.toLocaleString()} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 
                        read: false, 
                        timestamp: new Date().toISOString() 
                    });
                    await checkAndUnlockFrozenOrders(targetUserRef.id);
                }

                closeModal('modal-recharge-confirm');
                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', action === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

            } catch(e) {
                closeModal('modal-recharge-confirm');
                alert("Error: " + e.message);
            }
        }

        // Helper: Alert & Close
        window.showAdminAlert = (title, msg) => {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const modal = document.getElementById('modal-admin-alert');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeModal = (id) => {
            const el = document.getElementById(id);
            if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
        }
    
    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏î‡∏¢ "‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå
      // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ + ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô + ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏á‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ß‡∏ô‡∏•‡∏π‡∏õ)
       // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏î‡∏¢ "‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö" ‡πÅ‡∏•‡∏∞ "‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°"
        // (Logic ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö + ‡∏Å‡∏≥‡πÑ‡∏£)
        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ + ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô + ‡∏ö‡∏ß‡∏Å‡∏Å‡∏≥‡πÑ‡∏£ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ + ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô + ‡∏ö‡∏ß‡∏Å‡∏Å‡∏≥‡πÑ‡∏£ + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô)
        async function checkAndUnlockFrozenOrders(userId) {
            try {
                const userRef = db.collection("users").doc(userId);
                const userSnap = await userRef.get();
                if (!userSnap.exists) return;
                
                const userData = userSnap.data();
                const currentBalance = parseFloat(userData.balance || 0); 

                const ordersSnap = await db.collection("orders")
                    .where("username", "==", userData.username)
                    .where("status", "==", "frozen")
                    .get();

                if (ordersSnap.empty) return;

                let totalFrozenNeeded = 0;
                ordersSnap.forEach(doc => { totalFrozenNeeded += parseFloat(doc.data().amount || 0); });

                console.log(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ: ${currentBalance}, ‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î Frozen: ${totalFrozenNeeded}`);

                if (Number(currentBalance.toFixed(2)) >= Number(totalFrozenNeeded.toFixed(2))) {
                    
                    let batch = db.batch();
                    let profitToAdd = 0; 

                    ordersSnap.forEach(doc => {
                        const orderData = doc.data();
                        const commission = parseFloat(orderData.commission || 0); 
                        profitToAdd += commission;

                        batch.update(doc.ref, {
                            status: 'completed',       
                            payment_status: 'paid',    
                            pay_time: new Date().toISOString(),
                            timestamp: new Date().toISOString()
                        });
                    });

                    const finalProfit = Number(profitToAdd.toFixed(2));

                    batch.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(finalProfit), 
                        commission: firebase.firestore.FieldValue.increment(finalProfit),
                        "trap_config.is_triggered": true, 
                        
                        // ‚úÖ‚úÖ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0
                        todayCount: 0
                    });

                    await batch.commit();

                    const netBalance = Number((currentBalance + finalProfit).toFixed(2));
                    
                    alert(`üîì ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!\n\n- ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${netBalance.toLocaleString()}\n- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß`);
                }
            } catch (e) {
                console.error("Auto Unlock Error:", e);
            }
        }
    </script>
    
    <div id="modal-recharge-confirm" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[150] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        <div id="rc-icon-bg" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gray-100 mb-4 transition-colors">
            <i id="rc-icon" class="fa-solid fa-question text-2xl text-gray-600"></i>
        </div>
        <h3 id="rc-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">...</h3>
        <div id="rc-desc" class="text-sm text-gray-500 mb-6">...</div>
        <div class="flex gap-3 justify-center">
            <button onclick="executeRechargeAction()" id="rc-btn-confirm" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2.5 bg-gray-600 text-base font-medium text-white hover:bg-gray-700 focus:outline-none transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button onclick="closeModal('modal-recharge-confirm')" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<div id="modal-admin-alert" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[160] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
            <i class="fa-solid fa-check text-2xl text-green-600"></i>
        </div>
        <h3 id="alert-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="alert-msg" class="text-sm text-gray-500 mb-6">...</p>
        <button onclick="closeModal('modal-admin-alert')" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-md px-4 py-2.5 bg-gray-800 text-base font-medium text-white hover:bg-gray-900 focus:outline-none transition">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
</div>
</div>

<div id="modal-admin-alert" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[160] backdrop-blur-sm font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100 modal-scale-in">
        <div id="alert-icon-bg" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
            <i id="alert-icon" class="fa-solid fa-check text-2xl text-green-600"></i>
        </div>
        <h3 id="alert-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="alert-msg" class="text-sm text-gray-500 mb-6">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
        <button onclick="closeModal('modal-admin-alert')" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-md px-4 py-2.5 bg-gray-800 text-base font-medium text-white hover:bg-gray-900 focus:outline-none transition">
            ‡∏ï‡∏Å‡∏•‡∏á (OK)
        </button>
    </div>
</div>

</body>
</html>