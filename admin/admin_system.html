<!DOCTYPE html>
<html lang="th">
<head>
    <script>
    // ตรวจสอบการ Login
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        window.location.href = '../admin_login/index.html';
    }
    </script>
    <meta charset="UTF-8">
    <title>System Settings</title>
    <link rel="stylesheet" href="js/admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script src="../index_user/js/firebase_config.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; }
        .sys-menu-header { color: #4b646f; background: #1a2226; padding: 10px 25px 10px 15px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .sys-menu-item { display: block; padding: 12px 15px; color: #b8c7ce; border-bottom: 1px solid #222d32; transition: all 0.3s; font-size: 13px; cursor: pointer; text-decoration: none; }
        .sys-menu-item:hover { background-color: #1e282c; color: #fff; }
        .sys-menu-item.active { background-color: #1e282c; color: #fff; border-left: 3px solid #00a65a; }
        .sys-menu-item i { width: 20px; margin-right: 10px; text-align: center; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <script src="js/admin_ui.js"></script>
    
    <script>
        renderAdminUI('system', 'system');

        // สร้าง Sidebar
        setTimeout(() => {
            const sidebarContainer = document.querySelector('aside') || document.getElementById('sidebar-menu'); 
            if (sidebarContainer) {
                sidebarContainer.innerHTML = `
                    <div class="h-full bg-[#222d32] overflow-y-auto custom-scroll pt-2">
                        <div class="sys-menu-header">การกำหนดค่าระบบ</div>
                        <a onclick="switchTab('params', this)" class="sys-menu-item active"><i class="fa-solid fa-gears"></i> การกำหนดค่าพารามิเตอร์ระบบ</a>
                        <a onclick="switchTab('menu', this)" class="sys-menu-item"><i class="fa-solid fa-list"></i> การจัดการเมนูระบบ</a>
                        <a onclick="switchTab('payment', this)" class="sys-menu-item"><i class="fa-solid fa-credit-card"></i> การจัดการวิธีการชำระเงิน</a>
                        <a onclick="switchTab('logs', this)" class="sys-menu-item"><i class="fa-solid fa-file-lines"></i> การจัดการบันทึกระบบ</a>
                        <div class="sys-menu-header">การจัดการการเข้าถึง</div>
                        <a onclick="switchTab('access', this)" class="sys-menu-item"><i class="fa-solid fa-shield-halved"></i> การควบคุมการเข้าถึง</a>
                        <a href="admin_system_users.html" class="sys-menu-item"><i class="fa-solid fa-users-gear"></i> การจัดการผู้ใช้ระบบ</a>
                    </div>
                `;
            }
        }, 100); 

        // สร้าง Main Content
        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-3 border-b shadow-sm mb-4 flex justify-between items-center">
                <div class="flex items-center gap-2 text-gray-600">
                    <i class="fa-solid fa-angles-right text-xs"></i>
                    <span class="font-bold text-sm" id="page-title">การกำหนดค่าพารามิเตอร์ระบบ</span>
                </div>
                <div class="flex items-center gap-3">
                    
                    <div class="text-xs text-gray-400">เวลา: <span id="clock" class="font-mono font-bold">--:--:--</span></div>
                </div>
            </div>

            <div id="content-area" class="px-2">
                <div id="tab-params" class="tab-content block">
                    <div class="p-10 text-center text-gray-400 bg-white rounded shadow-sm">หน้าพารามิเตอร์ (ยังไม่เปิดใช้งาน)</div>
                </div>

                <div id="tab-payment" class="tab-content hidden">
                    <div class="bg-white border-t-[3px] border-[#00c0ef] rounded shadow-sm mb-4">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-700"><i class="fa-brands fa-line text-green-500 mr-2"></i> ตั้งค่าช่องทางติดต่อ (LINE Official)</h3>
                            <div id="save-status" class="text-xs font-bold text-green-600 hidden"><i class="fa-solid fa-check"></i> บันทึกแล้ว</div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">LINE ID หลัก (Main)</label>
                                    <div class="flex items-center border rounded-md overflow-hidden focus-within:border-green-500 transition">
                                        <div class="bg-gray-100 px-3 py-2 border-r text-gray-500"><i class="fa-solid fa-user-check"></i></div>
                                        <input type="text" id="conf-line-main" class="w-full px-3 py-2 text-sm outline-none" placeholder="กำลังโหลด...">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">LINE ID สำรอง (Backup)</label>
                                    <div class="flex items-center border rounded-md overflow-hidden focus-within:border-green-500 transition">
                                        <div class="bg-gray-100 px-3 py-2 border-r text-gray-500"><i class="fa-solid fa-user-shield"></i></div>
                                        <input type="text" id="conf-line-backup" class="w-full px-3 py-2 text-sm outline-none" placeholder="กำลังโหลด...">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t flex justify-end">
                                <button onclick="saveLineConfig()" id="btn-save-line" class="bg-gray-300 text-white px-6 py-2 rounded shadow-md text-sm font-bold transition flex items-center gap-2 cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-save"></i> บันทึกการตั้งค่า
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-menu" class="tab-content hidden"><div class="p-10 text-center text-gray-400 bg-white rounded shadow-sm">หน้าจัดการเมนู</div></div>
                <div id="tab-logs" class="tab-content hidden"><div class="p-10 text-center text-gray-400 bg-white rounded shadow-sm">หน้าบันทึกระบบ</div></div>
                <div id="tab-access" class="tab-content hidden"><div class="p-10 text-center text-gray-400 bg-white rounded shadow-sm">หน้าควบคุมการเข้าถึง</div></div>
            </div>
        `;

        // --- Logic ---
        
        // 1. ตรวจสอบการเชื่อมต่อ Database (รอไฟล์ config ทำงาน)
        function checkDbConnection() {
            if (window.db) {
                const badge = document.getElementById('db-status-badge');
                
                
                // เปิดปุ่ม
                const btn = document.getElementById('btn-save-line');
                if(btn) {
                    btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    btn.classList.add('bg-[#00c0ef]', 'hover:bg-[#00acd6]');
                    btn.disabled = false;
                }

                // โหลดข้อมูลถ้าอยู่หน้า Payment
                if(!document.getElementById('tab-payment').classList.contains('hidden')) {
                    loadLineConfig();
                }
                return true;
            }
            return false;
        }

        // วนเช็คทุก 0.5 วินาที จนกว่าจะเจอ window.db จากไฟล์ config
        const dbCheckInterval = setInterval(() => {
            if(checkDbConnection()) {
                clearInterval(dbCheckInterval);
            }
        }, 500);

        // 2. สลับ Tab
        window.switchTab = (tabId, el) => {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.sys-menu-item').forEach(item => item.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = el.innerText.trim();
            
            if(tabId === 'payment') {
                if (!window.db) {
                    // ยังไม่โหลด
                } else {
                    loadLineConfig();
                }
            }
        }

        // 3. โหลดข้อมูล
        async function loadLineConfig() {
            if (!window.db) return;
            try {
                const doc = await window.db.collection('settings').doc('config').get();
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('conf-line-main').value = data.line_id_main || '';
                    document.getElementById('conf-line-backup').value = data.line_id_backup || '';
                } else {
                    document.getElementById('conf-line-main').placeholder = "@YOUR_ID";
                    document.getElementById('conf-line-backup').placeholder = "@BACKUP_ID";
                }
            } catch(e) {
                console.error("Load config error:", e);
            }
        }

        // 4. บันทึกข้อมูล
        window.saveLineConfig = async function() {
            if (!window.db) { alert("เชื่อมต่อ Database ไม่ได้"); return; }

            const btn = document.getElementById('btn-save-line');
            const status = document.getElementById('save-status');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังบันทึก...';
            btn.disabled = true;

            const mainId = document.getElementById('conf-line-main').value.trim();
            const backupId = document.getElementById('conf-line-backup').value.trim();

            try {
                await window.db.collection('settings').doc('config').set({
                    line_id_main: mainId,
                    line_id_backup: backupId
                }, { merge: true });

                status.classList.remove('hidden');
                setTimeout(() => status.classList.add('hidden'), 3000);

            } catch(e) {
                alert("เกิดข้อผิดพลาด: " + e.message);
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-save"></i> บันทึกการตั้งค่า';
                btn.disabled = false;
            }
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH');
        }, 1000);

    </script>
</body>
</html>