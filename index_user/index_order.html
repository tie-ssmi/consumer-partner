<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="title_order">Order Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>

    <script src="js/languages.js"></script>
</head>
<body class="flex justify-center h-screen w-screen overflow-hidden text-gray-800 bg-gray-100">
    <div class="w-full max-w-xl bg-white shadow-2xl relative flex flex-col h-full">
        
        <header class="bg-[#DC2626] text-white h-14 flex items-center justify-between px-4 shadow-md shrink-0 z-50">
            <button onclick="window.location.href='../index.html'" class="hover:bg-white/20 w-8 h-8 rounded-full flex items-center justify-center transition">
                <i class="fa-solid fa-chevron-left text-lg"></i>
            </button>
            <div class="font-bold text-lg" data-i18n="title_order">Orders Record</div>
            <div class="flex items-center gap-2">
                <button onclick="toggleNewsModal()" class="hover:bg-white/20 p-2 rounded-full transition"><i class="fa-solid fa-circle-info text-xl"></i></button>
                <button onclick="toggleFloatingNotif()" class="hover:bg-white/20 p-2 rounded-full relative transition">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <div class="notif-dot-badge absolute top-2 right-2 w-2 h-2 bg-yellow-400 rounded-full hidden"></div>
                </button>
            </div>
        </header>

        <div class="bg-gray-50 p-2 shrink-0">
            <div class="bg-white rounded-lg p-1 flex shadow-sm border border-gray-100">
                <button onclick="filterOrders('all')" class="tab-btn flex-1 py-2 text-xs font-bold rounded-md transition bg-[#DC2626] text-white shadow-sm" id="tab-all" data-i18n="tab_all">All</button>
                <button onclick="filterOrders('pending')" class="tab-btn flex-1 py-2 text-xs font-bold text-gray-500 rounded-md hover:bg-gray-50 transition" id="tab-pending" data-i18n="tab_pending">Pending</button>
                <button onclick="filterOrders('completed')" class="tab-btn flex-1 py-2 text-xs font-bold text-gray-500 rounded-md hover:bg-gray-50 transition" id="tab-completed" data-i18n="tab_completed">Completed</button>
                <button onclick="filterOrders('frozen')" class="tab-btn flex-1 py-2 text-xs font-bold text-gray-500 rounded-md hover:bg-gray-50 transition" id="tab-frozen" data-i18n="tab_frozen">Frozen</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 scroll-smooth" id="order-list">
            <div class="text-center text-gray-400 text-xs mt-10" data-i18n="loading_products">กำลังโหลดข้อมูล...</div>
        </div>

        <div id="bottom-nav" class="shrink-0 z-50 relative"></div>
        <div id="modal-container"></div> 
    </div>

    <script src="app.js"></script>
    
    <script>
        let allOrders = [];
        let productImagesMap = {}; 
        let currentFilter = 'all';

        // 1. เริ่มทำงานเมื่อเข้าหน้าเว็บ
        document.addEventListener('DOMContentLoaded', () => {
            if(typeof initLanguage === 'function') initLanguage(); // เปลี่ยนภาษาทันที
            setTimeout(fetchOrders, 500);
        });

        // 2. โหลดรูปสินค้าเตรียมไว้
        async function fetchProductImageMap() {
            try {
                const snap = await window.db.collection("products").get();
                snap.forEach(doc => {
                    const p = doc.data();
                    if (p.name && p.image) {
                        productImagesMap[p.name] = p.image;
                    }
                });
            } catch (e) { console.log("Error loading product images:", e); }
        }

        // 3. ดึงข้อมูลออเดอร์
        async function fetchOrders() {
            if (!window.db || !userData) return setTimeout(fetchOrders, 500);
            await fetchProductImageMap();

            const username = userData.username;
            window.db.collection("orders").where("username", "==", username).onSnapshot(snap => {
                allOrders = [];
                snap.forEach(doc => {
                    allOrders.push({ docId: doc.id, ...doc.data() });
                });
                renderOrders();
            });
        }

        // 4. แสดงผลออเดอร์ (พร้อมแปลภาษา)
        function renderOrders() {
            const container = document.getElementById('order-list');
            container.innerHTML = '';

            let filtered = allOrders.filter(o => {
                if(currentFilter === 'all') return true;
                return o.status === currentFilter;
            });

            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if(filtered.length === 0) {
                // ✅ ใช้ getTrans แปลคำว่า "ไม่มีข้อมูล"
                const noDataTxt = typeof getTrans === 'function' ? (getTrans('txt_no_data') || 'No Data') : 'ไม่มีรายการ';
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-300"><i class="fa-solid fa-clipboard-list text-4xl mb-2"></i><span class="text-xs">${noDataTxt}</span></div>`;
                return;
            }

            // เตรียมคำแปลที่จะใช้ใน Loop
            const txtAmt = typeof getTrans === 'function' ? (getTrans('n_amt') || 'ยอด') : 'Amount';
            const txtComm = typeof getTrans === 'function' ? (getTrans('txt_comm') || 'Comm') : 'Commission';
            const txtSubmit = typeof getTrans === 'function' ? (getTrans('btn_submit_order') || 'Submit') : 'Submit Order';
            const txtID = typeof getTrans === 'function' ? (getTrans('txt_order_id') || 'ID') : 'ID';

            filtered.forEach(o => {
                let finalImage = o.product_img;
                if (!finalImage || !finalImage.startsWith('http')) {
                    if (productImagesMap[o.product_name]) {
                        finalImage = productImagesMap[o.product_name];
                    }
                }

                let imgHtml = '';
                if (finalImage && finalImage.startsWith('http')) {
                    imgHtml = `<div class="w-16 h-16 rounded-lg bg-cover bg-center shrink-0 border border-gray-200" style="background-image: url('${finalImage}');"></div>`;
                } else {
                    imgHtml = `<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-300 text-2xl"><i class="fa-solid fa-box-open"></i></div>`;
                }

                // Badge สถานะ (แปลภาษาด้วย getTrans)
                let statusBadge = '';
                let actionButton = ''; 

                if(o.status === 'pending') {
                    // แปลคำว่า Pending
                    const statusTxt = typeof getTrans === 'function' ? (getTrans('tab_pending') || 'Pending') : 'Pending';
                    statusBadge = `<span class="text-[10px] font-bold text-orange-500 bg-orange-50 px-2 py-0.5 rounded border border-orange-100">${statusTxt}</span>`;
                    
                    actionButton = `
                        <div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                            <button onclick="retrySubmit('${o.docId}')" class="w-full bg-[#DC2626] text-white py-2.5 rounded-lg font-bold text-sm shadow hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> ${txtSubmit}
                            </button>
                        </div>
                    `;
                } 
                else if(o.status === 'completed') {
                    const statusTxt = typeof getTrans === 'function' ? (getTrans('tab_completed') || 'Success') : 'Success';
                    statusBadge = `<span class="text-[10px] font-bold text-green-500 bg-green-50 px-2 py-0.5 rounded border border-green-100">${statusTxt}</span>`;
                } 
                else if(o.status === 'frozen') {
                    const statusTxt = typeof getTrans === 'function' ? (getTrans('tab_frozen') || 'Frozen') : 'Frozen';
                    statusBadge = `<span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded border border-red-100">${statusTxt}</span>`;
                }

                const dateStr = o.timestamp ? new Date(o.timestamp).toLocaleString('th-TH', {day:'numeric', month:'numeric', hour:'2-digit', minute:'2-digit'}) : '';

                const html = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-3 border-b border-dashed border-gray-100 pb-2">
                        <div class="text-[10px] text-gray-400">
                            <div>${txtID}: ${o.order_id}</div>
                            <div class="mt-0.5"><i class="fa-regular fa-clock mr-1"></i>${dateStr}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="flex gap-3 items-center">
                        ${imgHtml} 
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-bold text-gray-700 line-clamp-2 leading-relaxed mb-1">${o.product_name || 'สินค้า'}</div>
                            <div class="flex justify-between items-end mt-2">
                                <div class="text-[10px] text-gray-500">${txtAmt}: <span class="font-bold text-gray-800">฿${parseFloat(o.amount).toLocaleString()}</span></div>
                                <div class="text-xs font-bold text-green-600">+${txtComm} ฿${parseFloat(o.commission).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${actionButton} 
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${o.status==='completed'?'bg-green-500':(o.status==='frozen'?'bg-red-500':'bg-orange-400')}"></div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // 5. ฟังก์ชันกดปุ่มยืนยัน
        function retrySubmit(docId) {
            const orderData = allOrders.find(o => o.docId === docId);
            if (orderData) {
                window.currentMatchedOrder = orderData;
                setTxt('match-id', `Order: ${orderData.order_id}`);
                setTxt('match-time', new Date().toLocaleString('th-TH'));
                setTxt('match-name', orderData.product_name);
                setTxt('match-price', formatMoney(orderData.amount));
                setTxt('match-total', formatMoney(orderData.amount));
                setTxt('match-comm', '+' + formatMoney(orderData.commission));
                const total = parseFloat(orderData.amount) + parseFloat(orderData.commission);
                setTxt('match-return', formatMoney(total));

                const imgEl = document.getElementById('match-img');
                if(imgEl) {
                    let imgUrl = orderData.product_img;
                    if (!imgUrl || !imgUrl.startsWith('http')) {
                        if (productImagesMap[orderData.product_name]) {
                            imgUrl = productImagesMap[orderData.product_name];
                        }
                    }
                    if(imgUrl && imgUrl.startsWith('http')) { 
                        imgEl.style.backgroundImage = `url('${imgUrl}')`; 
                        imgEl.innerHTML = ''; 
                    } else { 
                        imgEl.style.backgroundImage = 'none'; 
                        imgEl.innerHTML = '<i class="fa-solid fa-box-open text-3xl text-gray-300 flex items-center justify-center h-full"></i>'; 
                    }
                }
                showModal('modal-matched-order');
            } else {
                alert("ไม่พบข้อมูล");
            }
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn flex-1 py-2 text-xs font-bold text-gray-500 rounded-md hover:bg-gray-50 transition';
            });
            const activeBtn = document.getElementById('tab-' + status);
            activeBtn.className = 'tab-btn flex-1 py-2 text-xs font-bold rounded-md transition bg-[#DC2626] text-white shadow-sm';
            renderOrders();
        }
    </script>
</body>
</html>