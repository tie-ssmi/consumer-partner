<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="reg_header">Register</title>
    <script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Logo ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Login
    const link = document.createElement('link');
    link.rel = 'icon';
    link.href = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAMAAACTisy7AAAAKlBMVEVHcEx4GUR3GkV3IUd4GER4HkZ4OFJ3Ikh4IUh4GUV3Ikd4G0V3GUV4F0Q+WLQcAAAADXRSTlMAq88+9WYMKk/nG4q7F5KB4wAAAJ9JREFUKJGVkksShCAMRAmCQID7X3eCUuZDNtMr24cJ3WUI/+iClhpcLovzVbxPluang0Zms9l9U6pqCAqO510Z67HoqXtu3iY7kBeVcywfj1XBTFBYGZNcCLe0RZinQXW2aCbCwbJ9jU59J+e51GbN9AWKXvC9RsKd2NSWIQJdvKp1RrIaK5TLrTgGnpATezv7Zt2DYXAXjipl8v/KUz+skhAyQOCYWgAAAABJRU5ErkJggg=="; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö app.js
    document.head.appendChild(link);
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    
    <script src="js/languages.js"></script>

    <style>
        * { font-family: 'Kanit', sans-serif; }
        body { background-color: #f3f4f6; }
        .red-header {
            background: linear-gradient(135deg, #d00000 0%, #ff0000 100%);
            height: 200px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ */
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            overflow: hidden;
        }
        .input-group {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            background-color: #f9fafb;
            transition: 0.3s;
        }
        .input-group:focus-within {
            border-color: #d00000;
            background-color: #fff;
        }
        input:focus, select:focus { outline: none; }
        
        /* Checkbox Style */
        .custom-checkbox input:checked + div {
            background-color: #d00000;
            border-color: #d00000;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }
    </style>
</head>
<body class="flex justify-center min-h-screen">

    <div class="w-full max-w-md bg-white shadow-2xl relative flex flex-col min-h-screen">
        <div class="red-header w-full flex flex-col pt-8 px-6">
            <div class="flex justify-between items-center text-white mb-4 relative z-10">
                <i class="fa-solid fa-chevron-left text-xl cursor-pointer hover:scale-110 transition" onclick="history.back()"></i>
                <h1 class="text-xl font-bold" data-i18n="reg_header">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h1>
                <i class="fa-solid fa-globe text-xl cursor-pointer hover:scale-110 transition" onclick="openLangModal()"></i>
            </div>
        </div>

        <div class="px-6 -mt-24 relative z-10 flex-1 pb-10">
            <div class="bg-white rounded-2xl shadow-lg p-6 space-y-4">
                
                <div>
                    <label class="block text-xs text-red-500 mb-1 font-medium" data-i18n="reg_mobile">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <div class="flex items-center input-group">
                        <div class="relative mr-2">
                            <select id="country-code" class="bg-transparent text-sm font-bold text-gray-700 cursor-pointer appearance-none pr-4 focus:outline-none">
                                <option value="+66">TH +66</option>
                                <option value="+856">LA +856</option>
                                <option value="+95">MM +95</option>
                                <option value="+84">VN +84</option>
                                <option value="+855">KH +855</option>
                                <option value="+81">JP +81</option>
                                <option value="+86">CN +86</option>
                            </select>
                            <i class="fa-solid fa-chevron-down text-[10px] text-gray-400 absolute right-0 top-1.5 pointer-events-none"></i>
                        </div>
                        <div class="w-[1px] h-5 bg-gray-300 mx-2"></div>
                        <input type="tel" id="reg-phone" class="flex-1 bg-transparent px-2 text-gray-800 text-sm font-medium" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" data-i18n="reg_ph_mobile">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-red-500 mb-1 font-medium" data-i18n="reg_pass">*‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</label>
                    <div class="input-group">
                        <input type="password" id="reg-password" class="w-full bg-transparent px-2 text-gray-800 text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" data-i18n="reg_ph_pass">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-red-500 mb-1 font-medium" data-i18n="reg_confirm_pass">*‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <div class="input-group">
                        <input type="password" id="reg-confirm-password" class="w-full bg-transparent px-2 text-gray-800 text-sm" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" data-i18n="reg_ph_confirm_pass">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-red-500 mb-1 font-medium" data-i18n="reg_invite">*‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏ç</label>
                    <div class="input-group">
                        <input type="text" id="reg-invite-code" class="w-full bg-transparent px-2 text-gray-800 text-sm" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç" data-i18n="reg_ph_invite">
                    </div>
                </div>

                <label class="flex items-center gap-2 cursor-pointer custom-checkbox mt-2">
                    <input type="checkbox" id="reg-agree" class="hidden">
                    <div class="w-4 h-4 border border-gray-300 rounded flex items-center justify-center transition">
                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-xs text-gray-500" data-i18n="reg_agree">‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                </label>

                <button onclick="handleRegister()" id="btn-register" class="w-full bg-[#e60000] text-white py-3 rounded-lg font-bold text-base shadow-md hover:bg-[#cc0000] active:scale-95 transition mt-4" data-i18n="reg_btn_submit">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏¢
                </button>

            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[150] backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-72 p-6 text-center shadow-2xl relative animate-[scaleIn_0.2s_ease-out]">
            <div id="modal-icon" class="mb-4 text-4xl"></div>
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-2"></h3>
            <p id="modal-msg" class="text-sm text-gray-500 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-[#d00000] text-white py-2.5 rounded-xl font-bold shadow hover:bg-[#b00000] transition" data-i18n="confirm">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script>
        // --- Multi-Language Logic (‡∏Å‡πä‡∏≠‡∏õ‡∏°‡∏≤‡∏à‡∏≤‡∏Å login.html) ---
        function changeLanguage(langCode) {
            if (typeof translations === 'undefined' || !translations[langCode]) return;
            localStorage.setItem('selectedLang', langCode);
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[langCode][key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[langCode][key];
                    } else {
                        el.innerHTML = translations[langCode][key];
                    }
                }
            });
            const modal = document.getElementById('modal-language');
            if(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        }

        function getTrans(key) {
            const lang = localStorage.getItem('selectedLang') || 'th';
            if (translations && translations[lang] && translations[lang][key]) {
                return translations[lang][key];
            }
            return key;
        }

        function initLanguage() {
            const savedLang = localStorage.getItem('selectedLang') || 'th';
            changeLanguage(savedLang);
        }

        function openLangModal() {
            // (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î Modal ‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πä‡∏≠‡∏õ‡∏à‡∏≤‡∏Å login.html ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ú‡∏°‡∏Ç‡∏≠‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô HTML ‡∏Ç‡∏≠‡∏á Modal ‡∏†‡∏≤‡∏©‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
            // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡πä‡∏≠‡∏õ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openLangModal ‡∏à‡∏≤‡∏Å login.html ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
             if (!document.getElementById('modal-language')) {
                const modalHtml = `
                <div id="modal-language" class="fixed inset-0 z-[200] bg-black/60 hidden items-center justify-center p-4 font-sans backdrop-blur-sm">
                    <div class="bg-white rounded-xl w-full max-w-xs overflow-hidden animate-[scaleIn_0.2s_ease-out]">
                        <div class="bg-[#DC2626] text-white p-4 flex justify-between items-center">
                            <h3 class="font-bold text-lg" data-i18n="lang_select">Select Language</h3>
                            <button onclick="document.getElementById('modal-language').classList.add('hidden');document.getElementById('modal-language').classList.remove('flex')" class="text-white hover:text-gray-200"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                        <div class="divide-y divide-gray-100 max-h-[60vh] overflow-y-auto custom-scroll">
                            <div onclick="changeLanguage('th')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üáπüá≠</span> <span class="text-gray-700 font-bold text-sm">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</span></div>
                            <div onclick="changeLanguage('en')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üá¨üáß</span> <span class="text-gray-700 font-bold text-sm">English</span></div>
                            <div onclick="changeLanguage('mm')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üá≤üá≤</span> <span class="text-gray-700 font-bold text-sm">Myanmar</span></div>
                            <div onclick="changeLanguage('zh')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üá®üá≥</span> <span class="text-gray-700 font-bold text-sm">Chinese (‰∏≠Êñá)</span></div>
                            <div onclick="changeLanguage('jp')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üáØüáµ</span> <span class="text-gray-700 font-bold text-sm">Japanese (Êó•Êú¨Ë™û)</span></div>
                            <div onclick="changeLanguage('vn')" class="p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer"><span class="text-2xl">üáªüá≥</span> <span class="text-gray-700 font-bold text-sm">Vietnamese (Ti·∫øng Vi·ªát)</span></div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            const modal = document.getElementById('modal-language');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // --- Alert Modal Logic ---
        function showModal(title, msg, isSuccess = false) {
            const modal = document.getElementById('custom-modal');
            const iconEl = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const msgEl = document.getElementById('modal-msg');

            titleEl.innerText = title;
            msgEl.innerText = msg;

            if (isSuccess) {
                iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
            } else {
                iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation text-red-500"></i>';
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        }

        // --- Register Logic (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
        async function handleRegister() {
            const countryCode = document.getElementById('country-code').value;
            let phoneInput = document.getElementById('reg-phone').value.trim();
            const pass = document.getElementById('reg-password').value.trim();
            const confirmPass = document.getElementById('reg-confirm-password').value.trim();
            const inviteCode = document.getElementById('reg-invite-code').value.trim();
            const isAgree = document.getElementById('reg-agree').checked;

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            if (!phoneInput || !pass || !confirmPass || !inviteCode) {
                showModal(getTrans('alert_error'), getTrans('alert_fill_info'));
                return;
            }

            if (!isAgree) {
                showModal(getTrans('alert_error'), getTrans('alert_term_agree'));
                return;
            }

            if (pass !== confirmPass) {
                showModal(getTrans('alert_error'), getTrans('alert_pass_mismatch'));
                return;
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ï‡∏±‡∏î 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (phoneInput.startsWith('0')) {
                phoneInput = phoneInput.substring(1);
            }
            const fullPhone = `${countryCode} ${phoneInput}`;

            const btn = document.getElementById('btn-register');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            try {
                // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                const userCheck = await window.db.collection("users").where("phone", "==", fullPhone).get();
                if (!userCheck.empty) {
                    throw new Error(getTrans('alert_user_exists'));
                }

                // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç (Invite Code) ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?
                // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ User ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ invite_code ‡∏ô‡∏µ‡πâ
                const inviteCheck = await window.db.collection("users").where("invite_code", "==", inviteCode).get();
                if (inviteCheck.empty) {
                    throw new Error(getTrans('alert_invite_invalid'));
                }

                // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Invite Code ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ User ‡∏ô‡∏µ‡πâ (‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å)
                let newInviteCode;
                let isUnique = false;
                while (!isUnique) {
                    newInviteCode = Math.floor(100000 + Math.random() * 900000).toString();
                    const checkCode = await window.db.collection("users").where("invite_code", "==", newInviteCode).get();
                    if (checkCode.empty) isUnique = true;
                }

                // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase
                await window.db.collection("users").add({
                    username: phoneInput, // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô username
                    phone: fullPhone,
                    password: pass,
                    invite_code: newInviteCode, // ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                    referrer_code: inviteCode,  // ‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏°‡∏≤
                    balance: 0,
                    level: "VIP 1",
                    credit: 100,
                    todayCount: 0,
                    timestamp: new Date().toISOString()
                });

                // 6. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
                showModal(getTrans('alert_reg_success'), getTrans('alert_success'), true);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);

            } catch (error) {
                console.error("Register Error:", error);
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏à‡∏≤‡∏Å Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ Throw ‡πÄ‡∏≠‡∏á)
                let errMsg = error.message;
                showModal(getTrans('alert_reg_fail'), errMsg);
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initLanguage, 100);
        });
    </script>
</body>
</html>