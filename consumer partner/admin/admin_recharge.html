<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style> 
        .table-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; } 
        th, td { padding: 14px 10px; font-size: 11px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        tr:hover { background-color: #f8fafc; transition: 0.2s; }
        .badge-pending { background-color: #fff7ed; color: #c2410c; }
        .badge-approved { background-color: #f0fdf4; color: #15803d; }
        .badge-rejected { background-color: #fef2f2; color: #b91c1c; }
        .btn-action { padding: 5px 10px; border-radius: 6px; color: white; font-size: 10px; cursor: pointer; }
        .btn-approve { background-color: #10b981; } .btn-reject { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <script src="admin_ui.js"></script>
    <script src="firebase_setup.js"></script> 

    <script>
        renderAdminUI('finance', 'recharge'); 

        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-5 shadow-sm border-b flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Recharge)</h2>
                <button onclick="fetchRecharges()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded text-xs font-bold hover:bg-indigo-100"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 mx-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <select id="filter-status" onchange="renderTable()" class="border px-3 py-2 text-xs rounded-lg"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option><option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option><option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option></select>
                    <input type="text" id="search-input" onkeyup="renderTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border pl-9 pr-3 py-2 text-xs rounded-lg w-full">
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mx-4 overflow-hidden">
                <div class="table-wrapper custom-scroll">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="pl-6">Order ID</th>
                                <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                <th class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="text-center pr-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="recharge-body"></tbody>
                    </table>
                </div>
            </div>
        `;

        let allRecharges = [];
        function formatDateTime(isoString) { if(!isoString) return "-"; const d = new Date(isoString); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

        function fetchRecharges() {
            if (!window.db) return setTimeout(fetchRecharges, 1000);
            db.collection("recharges").onSnapshot((snapshot) => {
                allRecharges = [];
                snapshot.forEach(doc => allRecharges.push({ docId: doc.id, ...doc.data() }));
                renderTable();
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recharge-body');
            const statusFilter = document.getElementById('filter-status').value;
            const searchText = document.getElementById('search-input').value.toLowerCase();
            allRecharges.sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            let html = '';
            allRecharges.forEach(r => {
                if (statusFilter !== 'all' && r.status !== statusFilter) return;
                if (searchText && !r.username.toLowerCase().includes(searchText)) return;
                const amount = parseFloat(r.amount);
                let statusBadge, actions;
                if (r.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending p-1 rounded text-xs">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                    actions = `<button onclick="processRecharge('${r.docId}', 'approve', ${amount}, '${r.user_id}', '${r.username}')" class="btn-action btn-approve mr-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="processRecharge('${r.docId}', 'reject')" class="btn-action btn-reject">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>`;
                } else if (r.status === 'approved') { statusBadge = '<span class="badge badge-approved p-1 rounded text-xs">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>'; actions = '-'; }
                else { statusBadge = '<span class="badge badge-rejected p-1 rounded text-xs">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>'; actions = '-'; }
                html += `<tr class="border-b hover:bg-gray-50"><td class="pl-6 font-mono text-xs text-gray-500">${r.order_id}</td><td><div class="font-bold text-gray-700 text-sm">${r.username}</div><div class="text-[10px] text-gray-400">${r.phone||'-'}</div></td><td><span class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-[10px] font-bold">${r.level||'Top-up'}</span></td><td class="text-right font-bold text-gray-800 text-sm">‡∏ø${amount.toLocaleString()}</td><td class="text-center text-[10px]">${r.type||'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô'}</td><td class="text-xs text-gray-500">${formatDateTime(r.timestamp)}</td><td class="text-center">${statusBadge}</td><td class="text-center pr-6 flex justify-center py-3">${actions}</td></tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="8" class="text-center p-12 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        }

        async function processRecharge(docId, action, amount = 0, userId = null, username = null) {
            let confirmMsg = action === 'approve' ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î ‡∏ø${amount}?` : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò?";
            if(confirm(confirmMsg)) {
                try {
                    let targetUserRef = null;
                    if (action === 'approve') {
                        let docSnap = await db.collection("users").doc(userId).get();
                        if (docSnap.exists) targetUserRef = docSnap.ref;
                        else {
                            let querySnap = await db.collection("users").where("id", "==", userId).limit(1).get();
                            if (!querySnap.empty) targetUserRef = querySnap.docs[0].ref;
                            else if (username) {
                                let userQuery = await db.collection("users").where("username", "==", username).limit(1).get();
                                if (!userQuery.empty) targetUserRef = userQuery.docs[0].ref;
                            }
                        }
                        if (!targetUserRef) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö User ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"); return; }
                    }
                    const status = action === 'approve' ? 'approved' : 'rejected';
                    await db.collection("recharges").doc(docId).update({ status: status });
                    if (action === 'approve' && targetUserRef) {
                        await db.runTransaction(async (transaction) => {
                            const userDoc = await transaction.get(targetUserRef);
                            const currentBal = parseFloat(userDoc.data().balance) || 0;
                            transaction.update(targetUserRef, { balance: currentBal + parseFloat(amount) });
                        });
                        await db.collection("notifications").add({ user_id: targetUserRef.id, title: 'üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', message: `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount.toLocaleString()} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, read: false, timestamp: new Date().toISOString() });
                    }
                    alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch(e) { alert("Error: " + e.message); }
            }
        }
        fetchRecharges();
    </script>
</body>
</html>