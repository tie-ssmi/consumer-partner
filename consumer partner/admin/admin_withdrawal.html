<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin - ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="admin_style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style> 
        .table-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; } 
        th, td { padding: 12px 10px; font-size: 11px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; }
        th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        tr:hover { background-color: #f8fafc; }
        .btn-status { padding: 3px 8px; border-radius: 4px; font-size: 10px; color: white; display: inline-block; }
        .bg-pending { background-color: #f59e0b; } .bg-approved { background-color: #10b981; } .bg-rejected { background-color: #ef4444; }
        .btn-action { padding: 4px 8px; border-radius: 4px; color: white; font-size: 10px; cursor: pointer; transition: 0.2s; margin-right: 2px; }
        .btn-approve { background-color: #f59e0b; } .btn-reject { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <script src="admin_ui.js"></script>
    <script src="firebase_setup.js"></script> 

    <script>
        renderAdminUI('finance', 'withdrawal'); 

        document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-5 shadow-sm border-b flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üí∏ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Withdrawal)</h2>
                <button onclick="fetchWithdrawals()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 mx-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <select id="filter-status" onchange="renderTable()" class="border px-3 py-1.5 text-xs rounded bg-white w-40"><option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option><option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option><option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option></select>
                    <input type="text" id="search-input" onkeyup="renderTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border px-3 py-1.5 text-xs rounded w-64">
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mx-4 overflow-hidden">
                <div class="table-wrapper custom-scroll">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="pl-4">ID</th>
                                <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                <th class="text-right">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (5%)</th>
                                <th class="text-right">‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="text-center pr-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="withdraw-body"></tbody>
                    </table>
                </div>
            </div>
        `;

        let allWithdrawals = [];
        function formatDateTime(isoString) { if(!isoString) return "-"; const d = new Date(isoString); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }

        function fetchWithdrawals() {
            if (!window.db) return setTimeout(fetchWithdrawals, 1000);
            db.collection("withdrawals").onSnapshot((snapshot) => {
                allWithdrawals = [];
                snapshot.forEach(doc => allWithdrawals.push({ docId: doc.id, ...doc.data() }));
                renderTable();
            });
        }

        function renderTable() {
            const tbody = document.getElementById('withdraw-body');
            const statusFilter = document.getElementById('filter-status').value;
            const searchText = document.getElementById('search-input').value.toLowerCase();
            allWithdrawals.sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            let html = '';
            allWithdrawals.forEach(w => {
                if (statusFilter !== 'all' && w.status !== statusFilter) return;
                if (searchText && !w.username.toLowerCase().includes(searchText)) return;
                const amount = parseFloat(w.amount);
                const fee = amount * 0.05;
                const receive = amount - fee;
                const orderId = 'WD' + w.timestamp.replace(/\D/g, '').substring(0, 8);
                let statusBadge, actions;
                if (w.status === 'pending') {
                    statusBadge = '<span class="text-orange-500 font-bold text-xs">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                    actions = `<button onclick="processWithdraw('${w.docId}', 'approve', ${amount}, '${w.user_id}')" class="btn-action btn-approve">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="processWithdraw('${w.docId}', 'reject', ${amount}, '${w.user_id}')" class="btn-action btn-reject">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>`;
                } else if (w.status === 'approved') { statusBadge = '<span class="btn-status bg-approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>'; actions = '-'; }
                else { statusBadge = '<span class="btn-status bg-rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>'; actions = '-'; }
                html += `<tr class="border-b hover:bg-gray-50"><td class="pl-4 text-xs text-gray-500">${orderId}</td><td><div class="font-bold text-blue-600">${w.username}</div></td><td class="text-right font-bold">‡∏ø${amount.toLocaleString()}</td><td class="text-right text-red-500 text-[10px]">‡∏ø${fee.toFixed(2)}</td><td class="text-right font-bold text-green-600">‡∏ø${receive.toLocaleString()}</td><td><div class="text-xs font-bold">${w.bank_name}</div><div class="text-[10px] text-gray-500">${w.account_number}</div></td><td class="text-xs text-gray-500">${formatDateTime(w.timestamp)}</td><td class="text-center">${statusBadge}</td><td class="text-center pr-4">${actions}</td></tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="10" class="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        }

        async function processWithdraw(docId, action, amount = 0, userId = null) {
            let confirmMsg = action === 'approve' ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?" : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò? (‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ User)";
            if(confirm(confirmMsg)) {
                try {
                    const status = action === 'approve' ? 'approved' : 'rejected';
                    await db.collection("withdrawals").doc(docId).update({ status: status });
                    if (action === 'reject' && userId) {
                        const userRef = db.collection("users").doc(userId);
                        await db.runTransaction(async (transaction) => {
                            const userDoc = await transaction.get(userRef);
                            if (!userDoc.exists) throw "User not found";
                            const newBalance = (parseFloat(userDoc.data().balance) || 0) + parseFloat(amount);
                            transaction.update(userRef, { balance: newBalance });
                        });
                    }
                    if (userId) {
                        let title = action === 'approve' ? '‚úÖ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
                        let msg = action === 'approve' ? `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß` : `‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount} ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤`;
                        await db.collection("notifications").add({ user_id: userId, title: title, message: msg, read: false, timestamp: new Date().toISOString() });
                    }
                    alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
                } catch(e) { alert("Error: " + e.message); }
            }
        }
        fetchWithdrawals();
    </script>
</body>
</html>