<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        /* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
        .wave-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, #3b82f6 100%);
            z-index: -1;
            clip-path: ellipse(80% 100% at 50% 100%);
        }
        .wave-bg-2 {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: #60a5fa;
            opacity: 0.3;
            z-index: -2;
            clip-path: ellipse(100% 100% at 50% 100%);
        }
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏° */
        .btn-login:active { transform: scale(0.98); }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Captcha */
        #captcha-canvas { cursor: pointer; border-radius: 4px; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen relative">

    <div class="wave-bg"></div>
    <div class="wave-bg-2"></div>

    <div class="bg-white/90 backdrop-blur-md p-10 rounded-2xl shadow-2xl w-full max-w-md border border-white mx-4">
        
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-700">System</h2>
            <h3 class="text-xl text-gray-500 tracking-widest mt-1">Management</h3>
        </div>

        <form onsubmit="handleLogin(event)" class="space-y-5">
            
            <div class="relative">
                <i class="fa-regular fa-user absolute left-4 top-3.5 text-gray-400"></i>
                <input type="text" id="username" placeholder="Please enter your login account" 
                    class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none transition" required>
            </div>

            <div class="relative">
                <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400"></i>
                <input type="password" id="password" placeholder="Login password" 
                    class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none transition" required>
            </div>

            <div class="flex gap-3">
                <div class="relative flex-1">
                    <i class="fa-regular fa-image absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="captcha-input" placeholder="VERIFICATION CODE" 
                        class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none transition uppercase" required>
                </div>
                <canvas id="captcha-canvas" width="100" height="46" class="bg-white shadow-sm" onclick="generateCaptcha()"></canvas>
            </div>

            <button type="submit" class="btn-login w-full bg-white border border-gray-200 text-gray-600 hover:bg-blue-600 hover:text-white hover:border-blue-600 font-bold py-3 rounded-lg shadow-sm transition-all duration-300 mt-4">
                Bind Now (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö)
            </button>

        </form>

        <p class="text-center text-xs text-gray-400 mt-8">
            Google Chrome is recommended.<br> System | Security
        </p>
    </div>

    <script src="../admin/firebase_setup.js"></script>

    <script>
        let currentCaptcha = "";

        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Captcha ‡∏à‡∏≥‡∏•‡∏≠‡∏á
        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏¢‡πÜ
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let captchaText = "";
            for (let i = 0; i < 4; i++) {
                captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentCaptcha = captchaText;

            // ‡∏ß‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÜ
            ctx.font = "bold 24px Arial";
            ctx.textBaseline = "middle";
            for (let i = 0; i < captchaText.length; i++) {
                ctx.save();
                ctx.translate(15 + i * 20, 25);
                ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillStyle = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'][Math.floor(Math.random()*4)];
                ctx.fillText(captchaText[i], 0, 0);
                ctx.restore();
            }
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
            for(let i=0; i<5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random()*100, Math.random()*46);
                ctx.lineTo(Math.random()*100, Math.random()*46);
                ctx.strokeStyle = '#e5e7eb';
                ctx.stroke();
            }
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login
        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username').value.trim();
            const passIn = document.getElementById('password').value.trim();
            const captchaIn = document.getElementById('captcha-input').value.trim().toUpperCase();

            // ‡πÄ‡∏ä‡πá‡∏Ñ Captcha
            if (captchaIn !== currentCaptcha) {
                alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Verification Code) ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                generateCaptcha(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
                document.getElementById('captcha-input').value = '';
                return;
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ Database
            try {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏•‡πå firebase_setup.js ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                if (!window.db) {
                    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö path ‡∏Ç‡∏≠‡∏á firebase_setup.js)");
                    return;
                }

                const snapshot = await db.collection('admins')
                    .where('username', '==', userIn)
                    .where('password', '==', passIn)
                    .get();

                if (!snapshot.empty) {
                    // Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
                    const adminData = snapshot.docs[0].data();
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß
                    localStorage.setItem('admin_logged_in', 'true');
                    localStorage.setItem('admin_name', adminData.name);
                    localStorage.setItem('admin_role', adminData.role);

                    localStorage.setItem('admin_username', adminData.username);

                    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞ redirect ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ)
                    // alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${adminData.name}`);
                    
                    // üëâ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö 1 ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏Ç‡πâ‡∏≤ admin)
                    window.location.href = '../admin/admin_dashboard.html';
                } else {
                    alert("‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    generateCaptcha();
                    document.getElementById('password').value = '';
                }

            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Captcha ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = generateCaptcha;
    </script>
</body>
</html>