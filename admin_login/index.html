<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        .wave-bg {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, #3b82f6 100%);
            z-index: -1; clip-path: ellipse(80% 100% at 50% 100%);
        }
        .wave-bg-2 {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: #60a5fa; opacity: 0.3; z-index: -2; clip-path: ellipse(100% 100% at 50% 100%);
        }
        .btn-login:active { transform: scale(0.98); }
        #captcha-canvas { cursor: pointer; border-radius: 4px; border: 1px solid #e5e7eb; }
        
        /* Animation */
        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-animate { animation: modalPop 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen relative">

    <div class="wave-bg"></div>
    <div class="wave-bg-2"></div>

    <div class="bg-white/90 backdrop-blur-md p-10 rounded-2xl shadow-2xl w-full max-w-md border border-white mx-4">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-700">System</h2>
            <h3 class="text-xl text-gray-500 tracking-widest mt-1">Management</h3>
        </div>

        <form onsubmit="handleLogin(event)" class="space-y-5">
            <div class="relative">
                <i class="fa-regular fa-user absolute left-4 top-3.5 text-gray-400"></i>
                <input type="text" id="username" placeholder="Please enter your login account" class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 outline-none transition" required>
            </div>
            <div class="relative">
                <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400"></i>
                <input type="password" id="password" placeholder="Login password" class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 outline-none transition" required>
            </div>
            <div class="flex gap-3">
                <div class="relative flex-1">
                    <i class="fa-regular fa-image absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="captcha-input" placeholder="CODE" class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-400 outline-none uppercase transition" required>
                </div>
                <canvas id="captcha-canvas" width="100" height="46" class="bg-white shadow-sm" onclick="generateCaptcha()"></canvas>
            </div>
            <button type="submit" id="btn-submit" class="btn-login w-full bg-white border border-gray-200 text-gray-600 hover:bg-blue-600 hover:text-white hover:border-blue-600 font-bold py-3 rounded-lg shadow-sm transition-all duration-300 mt-4">
                Bind Now (เข้าสู่ระบบ)
            </button>
        </form>

        <p class="text-center text-xs text-gray-400 mt-8">Google Chrome is recommended.<br> System | Security</p>
    </div>

    <div id="modal-alert" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center modal-animate relative overflow-hidden">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4 transition-colors" id="alert-icon-bg">
                <i id="alert-icon" class="fa-solid fa-circle-exclamation text-2xl text-red-600"></i>
            </div>
            <h3 id="alert-title" class="text-lg font-bold text-gray-900 mb-2">แจ้งเตือน</h3>
            <p id="alert-msg" class="text-sm text-gray-500 mb-6 leading-relaxed">...</p>
            <button onclick="closeModal('modal-alert')" class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-md px-4 py-2.5 bg-gray-800 text-base font-medium text-white hover:bg-gray-900 focus:outline-none transition">
                ตกลง (OK)
            </button>
        </div>
    </div>

    <div id="modal-banned" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[70] backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center modal-animate relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-red-500"></div>
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100 mb-5 shadow-inner">
                <i class="fa-solid fa-user-slash text-4xl text-red-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">บัญชีถูกระงับ</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                บัญชีผู้ใช้นี้ถูกระงับการใช้งานชั่วคราว<br>
                กรุณาติดต่อผู้ดูแลระบบสูงสุดเพื่อตรวจสอบ
            </p>
            <button onclick="closeModal('modal-banned')" class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-lg px-4 py-3 bg-red-600 text-base font-bold text-white hover:bg-red-700 focus:outline-none transition active:scale-95">
                รับทราบ (Acknowledge)
            </button>
        </div>
    </div>

    <script src="../admin/js/firebase_setup.js"></script>

    <script>
        let currentCaptcha = "";

        // --- Helper: แสดง Modal แจ้งเตือนแบบสวย ---
        function showModernAlert(title, msg, type = 'error') {
            const modal = document.getElementById('modal-alert');
            const iconBg = document.getElementById('alert-icon-bg');
            const icon = document.getElementById('alert-icon');

            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;

            if (type === 'error') {
                iconBg.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4';
                icon.className = 'fa-solid fa-circle-exclamation text-2xl text-red-600';
            } else {
                iconBg.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4';
                icon.className = 'fa-solid fa-circle-check text-2xl text-green-600';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex'); // ✅ เติม Flex เพื่อให้จัดกึ่งกลาง
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('hidden');
            modal.classList.remove('flex'); // ✅ เอา Flex ออกเมื่อปิด
        }

        // --- Captcha ---
        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f3f4f6'; ctx.fillRect(0,0, canvas.width, canvas.height);
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let captchaText = "";
            for (let i = 0; i < 4; i++) { captchaText += chars.charAt(Math.floor(Math.random() * chars.length)); }
            currentCaptcha = captchaText;
            ctx.font = "bold 24px Arial"; ctx.textBaseline = "middle";
            for (let i = 0; i < captchaText.length; i++) {
                ctx.save(); ctx.translate(15 + i * 20, 25); ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillStyle = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'][Math.floor(Math.random()*4)];
                ctx.fillText(captchaText[i], 0, 0); ctx.restore();
            }
            for(let i=0; i<5; i++) {
                ctx.beginPath(); ctx.moveTo(Math.random()*100, Math.random()*46); ctx.lineTo(Math.random()*100, Math.random()*46);
                ctx.strokeStyle = '#e5e7eb'; ctx.stroke();
            }
        }

        // --- Login Logic ---
        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username').value.trim();
            const passIn = document.getElementById('password').value.trim();
            const captchaIn = document.getElementById('captcha-input').value.trim().toUpperCase();
            const btn = document.getElementById('btn-submit');

            // 1. เช็ค Captcha (แสดง Modal สวยๆ แทน alert)
            if (captchaIn !== currentCaptcha) {
                showModernAlert("รหัสยืนยันไม่ถูกต้อง", "กรุณาตรวจสอบรหัสยืนยันอีกครั้ง");
                generateCaptcha(); 
                document.getElementById('captcha-input').value = ''; 
                return;
            }

            const oldText = btn.innerText;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังตรวจสอบ...';
            btn.disabled = true;

            try {
                if (!window.db) throw new Error("ไม่สามารถเชื่อมต่อฐานข้อมูลได้");

                const snapshot = await db.collection('admins')
                    .where('username', '==', userIn)
                    .where('password', '==', passIn)
                    .get();

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const adminData = doc.data();
                    
                    // 2. เช็คสถานะ (Banned)
                    if (adminData.status && (adminData.status === 'banned' || adminData.status === 'inactive')) {
                        // แสดง Modal Banned (พร้อมคำสั่งจัดกึ่งกลาง)
                        const bannedModal = document.getElementById('modal-banned');
                        bannedModal.classList.remove('hidden');
                        bannedModal.classList.add('flex'); // ✅ สำคัญ! ต้องมีบรรทัดนี้
                        
                        generateCaptcha();
                        btn.innerText = oldText;
                        btn.disabled = false;
                        return;
                    }

                    // ผ่านฉลุย -> บันทึกและไปต่อ
                    localStorage.setItem('admin_doc_id', doc.id);
                    localStorage.setItem('admin_logged_in', 'true');
                    localStorage.setItem('admin_name', adminData.name || adminData.username);
                    localStorage.setItem('admin_role', adminData.role || 'admin');
                    localStorage.setItem('admin_username', adminData.username);

                    window.location.href = '../admin/admin_dashboard.html';
                    
                } else {
                    // 3. รหัสผ่านผิด (แสดง Modal สวยๆ)
                    showModernAlert("เข้าสู่ระบบไม่สำเร็จ", "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
                    generateCaptcha();
                    document.getElementById('password').value = '';
                    btn.innerText = oldText;
                    btn.disabled = false;
                }
            } catch (error) {
                showModernAlert("เกิดข้อผิดพลาด", error.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        window.onload = () => {
            generateCaptcha();
            // เช็คว่าถูกดีดกลับมาหรือไม่
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'banned') {
                const bannedModal = document.getElementById('modal-banned');
                bannedModal.classList.remove('hidden');
                bannedModal.classList.add('flex'); // ✅ จัดกึ่งกลางทันที
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };
    </script>
</body>
</html>